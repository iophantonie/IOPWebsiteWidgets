<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IOP Cluster Widget v14.1 (Toggle Fix)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- CORE RESET & LAYOUT --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: transparent; overflow: hidden; 
            font-family: 'Segoe UI', 'Roboto', sans-serif; color: #e2e8f0; 
            overscroll-behavior: none;
        }

        :root {
            --phoenix-fire: #ff2a00;
            --bg-dark: #050505;
            --bg-panel: #0a0a0a;
            --border-color: #2a2a2a;
            --sidebar-width: 320px;
        }

        #app { position: absolute; inset: 0; display: flex; overflow: hidden; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width); height: 100%; 
            background: var(--bg-panel); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
            transition: width 0.3s ease, transform 0.3s ease;
            position: relative;
        }

        /* Collapsed State for Desktop */
        #sidebar.collapsed { width: 0; overflow: hidden; border-right: none; }

        /* Responsive Sidebar: Overlay on small screens */
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 280px; }
            #sidebar.open { transform: translateX(0); }
            /* Hide Desktop Toggle on Mobile */
            #sidebar-toggle { display: none !important; }
            /* Show Mobile Toggle */
            #mobile-toggle { display: flex !important; }
        }

        .sb-header { padding: 15px; background: rgba(0,0,0,0.5); border-bottom: 2px solid var(--phoenix-fire); flex-shrink: 0; white-space: nowrap; overflow: hidden; }
        .sb-title { font-size: 1.0rem; font-weight: 900; color: var(--phoenix-fire); letter-spacing: 0.05em; }
        
        .tabs { display: flex; background: rgba(17, 17, 17, 0.8); border-bottom: 1px solid var(--border-color); flex-shrink: 0; overflow: hidden; }
        .tab-btn { flex: 1; padding: 10px 5px; color: #777; background: none; border: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 700; transition: 0.2s; font-size: 0.75rem; text-align: center; }
        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: var(--phoenix-fire); border-color: var(--phoenix-fire); background: linear-gradient(to top, rgba(255, 42, 0, 0.15), transparent); }

        .sb-content { 
            flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; position: relative; padding: 15px;
            scrollbar-width: thin; scrollbar-color: #333 #0a0a0a;
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- DESKTOP TOGGLE BUTTON (FIXED POSITIONING) --- */
        #sidebar-toggle {
            position: absolute; 
            left: var(--sidebar-width); /* Initiale Position */
            top: 50%; transform: translateY(-50%);
            width: 24px; height: 48px; 
            background: #111; 
            border: 1px solid #444; border-left: none;
            border-radius: 0 6px 6px 0; 
            cursor: pointer; z-index: 60;
            display: flex; align-items: center; justify-content: center; color: #888;
            transition: left 0.3s ease, color 0.2s;
        }
        #sidebar-toggle:hover { color: var(--phoenix-fire); }
        
        /* Wenn Sidebar eingeklappt ist, rutscht der Button nach links */
        #sidebar.collapsed + #sidebar-toggle {
            left: 0;
            border-left: 1px solid #444; /* Rahmen wieder herstellen */
            border-radius: 0 6px 6px 0;
        }

        /* --- MOBILE TOGGLE --- */
        #mobile-toggle {
            position: absolute; top: 15px; left: 15px; z-index: 60;
            width: 40px; height: 40px; background: rgba(0,0,0,0.8); border-radius: 4px; border: 1px solid #444;
            display: none; align-items: center; justify-content: center; color: var(--phoenix-fire); font-size: 20px; cursor: pointer;
        }

        /* --- CUSTOM DROPDOWN (DINO SELECTOR) --- */
        .custom-select { position: relative; width: 100%; }
        .select-trigger {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 10px; background: #151515; border: 1px solid #444; border-radius: 6px;
            color: #ddd; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .select-trigger:hover { border-color: #666; }
        .select-trigger.active { border-color: var(--phoenix-fire); }
        
        .select-dropdown {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: #111; border: 1px solid #444; border-top: none; border-radius: 0 0 6px 6px;
            max-height: 350px; overflow-y: auto; z-index: 100; display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .select-dropdown.open { display: block; }
        
        .select-search { position: sticky; top: 0; background: #111; padding: 8px; border-bottom: 1px solid #333; z-index: 10; }
        .select-search input { width: 100%; background: #222; border: 1px solid #444; padding: 6px; border-radius: 4px; color: white; font-size: 0.85rem; outline: none; }
        .select-search input:focus { border-color: var(--phoenix-fire); }

        .select-item { display: flex; align-items: center; padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #1a1a1a; transition: 0.15s; font-size: 0.85rem; }
        .select-item:hover { background: #222; }
        .select-item.selected { background: rgba(255, 42, 0, 0.15); color: var(--phoenix-fire); }
        .select-item img { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }

        /* --- MAP ENGINE --- */
        #viewport {
            flex: 1; position: relative; background: transparent; overflow: hidden; display: block; min-width: 0;
        }

        #world {
            position: absolute; top: 0; left: 0; width: 1024px; height: 1024px;
            box-shadow: 0 0 100px rgba(0,0,0,0.5); transform-origin: 0 0; background-color: transparent;
            will-change: transform;
        }

        #map-image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: fill; z-index: 1; pointer-events: none; }
        #data-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #input-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: grab; }
        #input-layer:active { cursor: grabbing; }

        /* PULSING MARKER */
        .pulse-marker {
            position: absolute; width: 60px; height: 60px; border: 2px solid var(--phoenix-fire); border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--phoenix-fire), inset 0 0 10px var(--phoenix-fire);
            z-index: 5; pointer-events: none; animation: pulseRing 2s infinite; display: none; 
        }
        @keyframes pulseRing {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        /* --- UI ELEMENTS --- */
        .toggle-item { display: flex; align-items: center; padding: 6px 0; cursor: pointer; user-select: none; }
        .chk { width: 16px; height: 16px; border: 2px solid #444; border-radius: 3px; margin-right: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: #000; }
        .toggle-item:hover .chk { border-color: #888; }
        .toggle-item.checked .chk { background: var(--phoenix-fire); border-color: var(--phoenix-fire); }
        .toggle-item.checked .chk::after { content: '✓'; color: black; font-weight: bold; font-size: 10px; }
        .toggle-item.disabled { opacity: 0.5; cursor: not-allowed; }

        .hud-top { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.9); padding: 8px 12px; border-radius: 4px; color: var(--phoenix-fire); font-family: monospace; z-index: 50; border: 1px solid #333; pointer-events: none; }
        .hud-bot { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 8px; z-index: 50; }
        .zoom-btn { width: 40px; height: 40px; background: rgba(17, 17, 17, 0.8); border: 1px solid #444; color: white; border-radius: 6px; font-size: 18px; cursor: pointer; display: grid; place-items: center; backdrop-filter: blur(4px); }
        .zoom-btn:hover { border-color: var(--phoenix-fire); color: var(--phoenix-fire); }

        /* LEGEND */
        .map-legend {
            position: absolute; bottom: 20px; left: 20px; 
            width: 160px; background: rgba(10, 10, 10, 0.95);
            border: 1px solid #333; border-left: 3px solid var(--phoenix-fire);
            padding: 10px; z-index: 50; pointer-events: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            font-size: 10px; color: #ccc;
            display: flex; flex-direction: column; gap: 3px;
        }
        .legend-title { color: var(--phoenix-fire); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.05em; font-size: 9px; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .leg-item { display: flex; align-items: center; }
        .leg-box { width: 10px; height: 10px; margin-right: 8px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }

        /* INFO PANEL */
        .info-panel { 
            position: absolute; top: 0; right: 0; bottom: 0; width: 320px; 
            background: var(--bg-panel); border-left: 1px solid var(--phoenix-fire); 
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; 
        }
        .info-panel.visible { transform: translateX(0); }
        .info-header { padding: 15px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .info-title { font-size: 1.0rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.05em; }
        .info-close { color: #888; cursor: pointer; font-size: 1.5rem; transition: 0.2s; line-height: 1; }
        .info-close:hover { color: var(--phoenix-fire); }
        
        .related-list { margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; }
        .related-item { padding: 6px 8px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; color: #aaa; border-left: 2px solid transparent; margin-bottom: 2px; }
        .related-item:hover { background: #1a1a1a; color: white; }
        .related-item.active { background: rgba(255, 42, 0, 0.1); border-left-color: var(--phoenix-fire); color: var(--phoenix-fire); font-weight: bold; }

        /* Loader */
        .loader { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; backdrop-filter: blur(5px); }
        .loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top-color: var(--phoenix-fire); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Notification Toast */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 1px solid var(--phoenix-fire); color: white;
            padding: 15px 25px; border-radius: 8px; z-index: 200; pointer-events: none;
            opacity: 0; transition: opacity 0.3s;
        }
        #toast.visible { opacity: 1; }

        /* Utility */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .hidden { display: none !important; }
        .phoenix-input { w-full: 100%; background: #050505; border: 1px solid #333; padding: 8px; border-radius: 6px; color: white; outline: none; font-size: 0.9rem; }
        
        #error-log { position: absolute; top: 0; left: 0; width: 100%; background: rgba(220, 38, 38, 0.95); color: white; padding: 5px; font-size: 11px; z-index: 10000; display: none; text-align: center; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.ok { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-dot.err { background: #ef4444; }
        .status-dot.wait { background: #f59e0b; }
    </style>
</head>
<body>

<div id="error-log"></div>
<div id="toast">Nachricht</div>

<div id="loader" class="loader">
    <div class="spinner mb-4"></div>
    <div id="loader-msg" class="text-white font-bold text-sm tracking-widest uppercase" style="color: var(--phoenix-fire)">Lade System...</div>
</div>

<div id="app">
    <!-- MOBILE TOGGLE (Visible only on small screens) -->
    <div id="mobile-toggle" onclick="Ui.toggleSidebar()">☰</div>

    <div id="sidebar">
        <!-- DESKTOP TOGGLE (Sibling to sidebar content, but visually outside) -->
        <div id="sidebar-toggle" onclick="Ui.toggleSidebar()">◀</div>

        <div class="sb-header">
            <div class="text-xs text-gray-500 font-bold tracking-widest mb-1">INFINITY OF PHOENIX</div>
            <div class="sb-title">CLUSTER EXPLORER</div>
            <select id="map-select" class="phoenix-input mt-3 w-full text-sm"><option disabled selected>Karte...</option></select>
        </div>

        <nav class="tabs">
            <button class="tab-btn active" onclick="Ui.tab('dinos')">DINOS</button>
            <button class="tab-btn" onclick="Ui.tab('res')">RES.</button>
            <button class="tab-btn" onclick="Ui.tab('pois')">ORTE</button>
        </nav>

        <div class="sb-content custom-scrollbar">
            <!-- DINOS (COMPACT MODE) -->
            <div id="view-dinos" class="view active">
                <div class="text-xs font-bold text-gray-500 mb-2 tracking-wider">KREATUREN</div>
                
                <!-- CUSTOM DROPDOWN -->
                <div class="custom-select" id="dino-dropdown">
                    <div class="select-trigger" onclick="Ui.toggleDinoDropdown()">
                        <span id="dino-trigger-text">Wähle Dino...</span>
                        <span class="text-xs text-gray-500">▼</span>
                    </div>
                    
                    <div id="dino-dropdown-content" class="select-dropdown">
                        <div class="select-search">
                            <input type="text" id="search-dino" placeholder="Suche..." autocomplete="off">
                        </div>
                        <div id="dino-list-root"></div>
                    </div>
                </div>
            </div>
            
            <!-- RESSOURCEN -->
            <div id="view-res" class="view">
                <div class="mb-4 border-b border-gray-800 pb-2">
                    <div class="toggle-item" id="tog-all-res" onclick="Res.toggleAll()">
                        <div class="chk"></div>
                        <span class="text-xs font-bold text-gray-500 tracking-wider">ALLE RESSOURCEN</span>
                    </div>
                </div>
                <div id="list-res"></div>
            </div>

            <!-- ORTE -->
            <div id="view-pois" class="view">
                <div class="mb-6">
                    <div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">ALLGEMEIN</div>
                    
                    <div class="toggle-item mb-2" id="tog-all-pois" onclick="Layers.toggleAllPois()">
                        <div class="chk"></div><span class="text-amber-500 text-sm font-bold">Alle Orte einblenden</span>
                    </div>

                    <div class="pl-4 border-l-2 border-[#1a1a1a] ml-1">
                        <div class="toggle-item" id="tog-public" onclick="Layers.toggle('public')">
                            <div class="chk"></div><span>Public Spots</span>
                        </div>
                        <div class="toggle-item" id="tog-caves" onclick="Layers.toggle('caves')">
                            <div class="chk"></div><span>Höhlen</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">SPAWNS</div>
                    <div class="toggle-item" id="tog-players" onclick="Layers.toggle('players')">
                        <div class="chk"></div><span>Spieler Spawns</span>
                    </div>
                    <div id="spawn-status" class="text-xs text-gray-600 ml-8 mt-1 italic flex items-center">
                        <span id="st-spawn" class="status-dot wait"></span> Status: Prüfe...
                    </div>
                </div>

                <div>
                    <div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">OBELISKEN</div>
                    <div id="list-obelisks"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAP VIEWPORT -->
    <div id="viewport">
        <!-- THE VERTICAL LEGEND -->
        <div class="map-legend">
            <div class="legend-title">Spawn Raten</div>
            <div class="leg-item"><div class="leg-box" style="background: rgba(34, 197, 94, 0.9)"></div>Sehr Häufig</div>
            <div class="leg-item"><div class="leg-box" style="background: rgba(132, 204, 22, 0.9)"></div>Häufig</div>
            <div class="leg-item"><div class="leg-box" style="background: rgba(234, 179, 8, 0.9)"></div>Gelegentlich</div>
            <div class="leg-item"><div class="leg-box" style="background: rgba(249, 115, 22, 0.9)"></div>Selten</div>
            <div class="leg-item"><div class="leg-box" style="background: rgba(239, 68, 68, 0.9)"></div>Sehr Selten</div>
            <div class="leg-item"><div class="leg-box" style="background: rgba(168, 85, 247, 0.9)"></div>Extrem Selten</div>
            <div class="leg-item mt-2"><div class="leg-box" style="background: repeating-linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.2) 2px, transparent 2px, transparent 4px); border: 1px solid #777"></div>Höhle</div>
        </div>

        <div id="world">
            <img id="map-image-layer" src="" alt="Karte" crossorigin="anonymous">
            <canvas id="data-canvas"></canvas>
            <div id="selection-marker" class="pulse-marker"></div>
            <div id="input-layer"></div>
        </div>
        <div class="hud-top">LAT: <span id="lat">00.0</span> | LON: <span id="lon">00.0</span></div>
        <div class="hud-bot">
            <button class="zoom-btn" onclick="Ui.toggleFullscreen()" title="Vollbild">⛶</button>
            <button class="zoom-btn" onclick="MapEngine.reset()">⟲</button>
            <button class="zoom-btn" onclick="MapEngine.zoom(1.2)">+</button>
            <button class="zoom-btn" onclick="MapEngine.zoom(0.8)">-</button>
        </div>
    </div>
    
    <!-- INFO POPUP -->
    <div id="info-panel" class="info-panel">
        <div class="flex justify-between items-center bg-[#0a0a0a] p-4 border-b border-[#333]">
            <h2 id="info-title" class="text-lg font-bold text-white uppercase">Info</h2>
            <button onclick="Ui.closeInfo()" class="text-gray-400 hover:text-white text-xl">×</button>
        </div>
        <div id="info-body" class="p-4 text-sm text-gray-300 overflow-y-auto h-full"></div>
    </div>
</div>

<script>
/**
 * IOP WIDGET CORE v14.1 - Sidebar Toggle Fix
 */

window.CFG = {
    urlC: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/MapConfigs/MapConfigs.jsn',
    urlI: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/refs/heads/main/Icon_Datenbank/Icondb.jsn',
    urlT: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Translation_Datenbank/translationdb.jsn',
    col: { spawn: 'rgba(255, 42, 0, 0.4)', stroke: '#ff2a00' },
    rarity: [
        { th: 0.30, c: '#22c55e' }, 
        { th: 0.15, c: '#84cc16' }, 
        { th: 0.07, c: '#eab308' }, 
        { th: 0.03, c: '#f97316' }, 
        { th: 0.01, c: '#ef4444' }, 
        { th: 0.00, c: '#a855f7' }
    ]
};

function hexToRgba(hex, alpha) {
    if(!hex) return `rgba(255, 255, 255, ${alpha})`;
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

window.Store = {
    cfg: {}, map: null,
    dom: { mapImg: null },
    data: { dinos:{}, res:{}, pois:[], obs:[], caves:[], players:[] },
    icons: {}, trans: {d:{}, r:{}},
    selDino: null, selectedPOI: null,
    activeRes: new Set(), activeObs: new Set(),
    layers: { public: false, caves: false, players: false },
    view: { x:0, y:0, scale:1 },
    sidebarOpen: true
};

function logError(msg) {
    const el = document.getElementById('error-log');
    if(el) { el.style.display='block'; el.textContent=`ERROR: ${msg}`; }
    console.error(msg);
}
window.onerror = (m,u,l) => logError(`${m} (Line ${l})`);

async function fetchData(url) {
    try {
        const r = await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const t = await r.text();
        const cleaned = t.replace(/^\uFEFF/, '').replace(/\u00A0/g, ' ');
        return JSON.parse(cleaned);
    } catch(e) { console.warn("JSON Error", e); return null; }
}

function findSpawnGroups(rawData) {
    if (!rawData) return [];
    if (rawData.spawnPoints && Array.isArray(rawData.spawnPoints)) return rawData.spawnPoints; 
    let found = [];
    const search = (obj) => {
        if (!obj || typeof obj !== 'object') return;
        if (Array.isArray(obj)) {
             if(obj.length > 0 && (obj[0].locations || obj[0].lat !== undefined)) { found = obj; return; }
             obj.forEach(search);
        } else {
             if(obj.spawnPoints) { found = obj.spawnPoints; return; }
             Object.values(obj).forEach(search);
        }
    };
    search(rawData);
    if (found.length > 0) return found;
    if (Array.isArray(rawData) && rawData.length > 0 && rawData[0].lat !== undefined) {
         return [{ name: "Spawns", color: "#4ade80", locations: rawData }];
    }
    return [];
}

window.MapEngine = {
    el: null, cvs: null, ctx: null, img: null, marker: null,
    iconCache: new Map(),
    cavePattern: null,
    isDown: false, hasMoved: false, startX: 0, startY: 0,
    resizeObserver: null,

    init() {
        this.el = document.getElementById('world');
        this.img = document.getElementById('map-image-layer');
        this.cvs = document.getElementById('data-canvas');
        this.marker = document.getElementById('selection-marker');
        this.ctx = this.cvs.getContext('2d');
        Store.dom.mapImg = this.img;
        
        const pCvs = document.createElement('canvas');
        pCvs.width = 10; pCvs.height = 10;
        const pCtx = pCvs.getContext('2d');
        pCtx.strokeStyle = 'rgba(255,255,255,0.4)';
        pCtx.lineWidth = 1;
        pCtx.beginPath(); pCtx.moveTo(0, 10); pCtx.lineTo(10, 0); pCtx.stroke();
        this.cavePattern = this.ctx.createPattern(pCvs, 'repeat');
        
        const input = document.getElementById('input-layer');
        
        input.onmousedown = e => { 
            this.isDown = true; this.hasMoved = false; 
            this.startX = e.clientX; this.startY = e.clientY; 
            input.style.cursor='grabbing'; 
        };
        
        window.onmouseup = () => { this.isDown = false; input.style.cursor='grab'; };
        
        input.onmousemove = e => {
            if(this.isDown) {
                const dx = e.clientX - this.startX;
                const dy = e.clientY - this.startY;
                if(Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    this.hasMoved = true;
                    Store.view.x += dx; Store.view.y += dy;
                    this.startX = e.clientX; this.startY = e.clientY;
                    this.update();
                }
            }
            const r = this.el.getBoundingClientRect();
            const lat = ((e.clientY - r.top)/r.height)*100;
            const lon = ((e.clientX - r.left)/r.width)*100;
            const latEl = document.getElementById('lat');
            const lonEl = document.getElementById('lon');
            if(latEl) latEl.innerText = Math.max(0,Math.min(100, lat)).toFixed(1);
            if(lonEl) lonEl.innerText = Math.max(0,Math.min(100, lon)).toFixed(1);
        };
        
        input.onwheel = e => { 
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const rect = document.getElementById('viewport').getBoundingClientRect();
            this.zoomAt(delta, e.clientX - rect.left, e.clientY - rect.top);
        };

        input.onclick = e => {
            if(this.hasMoved) return;
            const r = this.el.getBoundingClientRect();
            const cx = e.clientX - r.left;
            const cy = e.clientY - r.top;
            const lon = (cx / r.width) * 100;
            const lat = (cy / r.height) * 100;
            this.checkClick(lon, lat);
        };

        this.resizeObserver = new ResizeObserver(() => this.fit());
        this.resizeObserver.observe(document.getElementById('viewport'));
        
        setTimeout(()=>this.fit(), 100);
        
        input.addEventListener('mousedown', () => {
             const dd = document.getElementById('dino-dropdown-content');
             const trig = document.querySelector('.select-trigger');
             if(dd.classList.contains('open')) {
                 dd.classList.remove('open');
                 trig.classList.remove('active');
             }
        });
    },

    fit() {
        if(!this.el) return;
        const vp = document.getElementById('viewport');
        const s = Math.min(vp.clientWidth, vp.clientHeight); 
        const size = Math.max(100, s);
        this.el.style.width = size+'px';
        this.el.style.height = size+'px';
        this.cvs.width = size;
        this.cvs.height = size;
        this.el.style.left = (vp.clientWidth - size)/2 + 'px';
        this.el.style.top = (vp.clientHeight - size)/2 + 'px';
        this.draw();
    },

    load(url) {
        if(!this.img) return;
        this.img.src = url;
        const loader = document.getElementById('loader');
        if(loader) loader.classList.remove('hidden');

        this.img.onload = () => {
             if(loader) loader.classList.add('hidden');
             this.fit();
             this.draw();
        };
        this.img.onerror = () => {
            console.warn("Map Image Load Failed: " + url);
            if(loader) loader.classList.add('hidden');
            this.draw();
        };
        this.setMarker(null);
    },

    update() { if(this.el) this.el.style.transform = `translate(${Store.view.x}px, ${Store.view.y}px) scale(${Store.view.scale})`; },
    
    zoomAt(factor, mx, my) {
        const oldScale = Store.view.scale;
        const newScale = Math.max(0.5, Math.min(10, oldScale * factor));
        if(newScale === oldScale) return;
        const rect = this.el.getBoundingClientRect();
        const relX = mx - rect.left;
        const relY = my - rect.top;
        const ratio = 1 - (newScale / oldScale);
        const unscaledX = relX / oldScale;
        const unscaledY = relY / oldScale;
        Store.view.x += (relX - (relX * (newScale / oldScale)));
        Store.view.y += (relY - (relY * (newScale / oldScale)));
        Store.view.scale = newScale;
        this.update();
    },

    zoomIn() { const vp = document.getElementById('viewport'); this.zoomAt(1.2, vp.clientWidth/2, vp.clientHeight/2); },
    zoomOut() { const vp = document.getElementById('viewport'); this.zoomAt(0.8, vp.clientWidth/2, vp.clientHeight/2); },
    reset() { Store.view.scale = 1; Store.view.x = 0; Store.view.y = 0; this.update(); this.fit(); },
    
    setMarker(data) {
        if(!data) { this.marker.style.display = 'none'; return; }
        this.marker.style.left = data.lon + '%';
        this.marker.style.top = data.lat + '%';
        this.marker.style.display = 'block';
    },

    getImg(url) {
        if(!url) return null;
        if(this.iconCache.has(url)) return this.iconCache.get(url);
        const i = new Image(); i.src = url;
        i.onload = () => this.draw();
        i.onerror = () => { console.warn("Broken Icon:", url); };
        this.iconCache.set(url, i);
        return i;
    },
    getResIcon(key) { return this.getImg(Store.icons[key]?.iconUrl); },

    draw() {
        if(!this.ctx || !this.cvs || !window.Store || !Store.data) return;
        const w = this.cvs.width, h = this.cvs.height;
        const ctx = this.ctx;
        ctx.clearRect(0, 0, w, h);
        
        if (this.img.naturalWidth === 0 && this.img.src) {
             ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,w,h);
             ctx.fillStyle = '#ff2a00'; ctx.font = '20px sans-serif'; ctx.textAlign = 'center';
             ctx.fillText("Bild konnte nicht geladen werden", w/2, h/2);
        }

        if(Store.selDino && Array.isArray(Store.data.dinos[Store.selDino])) {
            Store.data.dinos[Store.selDino].forEach(z => {
                const x = (z.min.lon/100)*w, y = (z.min.lat/100)*h;
                const zw = ((z.max.lon - z.min.lon)/100)*w, zh = ((z.max.lat - z.min.lat)/100)*h;
                const score = (z.chance || 0.5) * (z.weight || 1);
                let hex = '#22c55e';
                for(let r of window.CFG.rarity) { if(score >= r.th) { hex = r.c; break; } }
                ctx.fillStyle = hexToRgba(hex, 0.4); ctx.fillRect(x, y, zw, zh);
                if (z.isCave) { ctx.fillStyle = this.cavePattern; ctx.fillRect(x, y, zw, zh); }
                ctx.strokeStyle = hex; ctx.lineWidth = 2; ctx.strokeRect(x, y, zw, zh);
            });
        }

        Store.activeRes.forEach(k => {
            if(Array.isArray(Store.data.res[k])) {
                const img = this.getResIcon(k);
                const col = {'Metal':'#b87333'}[k] || '#fff';
                Store.data.res[k].forEach(p => {
                    const cx = (p.lon/100)*w, cy = (p.lat/100)*h;
                    const sz = Math.min(32, 12 + ((p.size||1)*2));
                    if(img && img.complete && img.naturalWidth > 0) ctx.drawImage(img, cx-sz/2, cy-sz/2, sz, sz);
                    else { ctx.fillStyle=col; ctx.beginPath(); ctx.arc(cx,cy,sz/3,0,6.28); ctx.fill(); }
                });
            }
        });

        if(Store.layers.public && Array.isArray(Store.data.pois)) this.drawPois(Store.data.pois, '#ff2a00', w, h);
        if(Store.layers.caves && Array.isArray(Store.data.caves)) this.drawPois(Store.data.caves, '#a855f7', w, h);
        
        Store.activeObs.forEach(k => {
            const o = Store.data.obs.find(i => i.name === k);
            if(o) {
                let img = o.icon ? this.getImg(o.icon) : null;
                if(!img) img = this.getImg(Store.icons[o.name]?.iconUrl);
                const cx=(o.lon/100)*w, cy=(o.lat/100)*h;
                if(img && img.complete && img.naturalWidth > 0) {
                    const ht=60, ar=img.naturalWidth/img.naturalHeight;
                    const wt=ht*ar;
                    ctx.drawImage(img, cx-(wt/2), cy-ht, wt, ht); 
                } else {
                    const c = o.name.includes('Rot') ? '#ef4444' : o.name.includes('Grün') ? '#22c55e' : '#3b82f6';
                    ctx.fillStyle=c; ctx.beginPath(); ctx.arc(cx,cy,8,0,6.28); ctx.fill();
                    ctx.lineWidth=2; ctx.strokeStyle='#fff'; ctx.stroke();
                }
            }
        });

        if (Store.layers.players && Store.data.players) {
            const spawns = Store.data.players; 
            const palette = ['#4ade80', '#60a5fa', '#facc15', '#f87171', '#c084fc', '#fb923c', '#2dd4bf', '#f472b6'];
            
            if (spawns.length === 0) Ui.toast("Keine Spieler-Spawns verfügbar");

            spawns.forEach((group, index) => {
                const color = group.color || palette[index % palette.length];
                ctx.fillStyle = color;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;

                const points = group.locations || group.spawnPoints || (Array.isArray(group) ? group : []);
                points.forEach(loc => {
                    if (loc.lat !== undefined) {
                         const cx = (loc.lon / 100) * w;
                         const cy = (loc.lat / 100) * h;
                         ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    }
                });
            });
        }
    },

    drawPois(list, c, w, h) {
        if (!Array.isArray(list)) return;
        const ctx = this.ctx;
        list.forEach(p => {
            const cx=(p.lon/100)*w, cy=(p.lat/100)*h;
            const img = p.icon ? this.getImg(p.icon) : null;
            if(img && img.complete && img.naturalWidth > 0) ctx.drawImage(img, cx-16, cy-16, 32, 32);
            else { ctx.fillStyle=c; ctx.beginPath(); ctx.arc(cx,cy,6,0,6.28); ctx.fill(); ctx.stroke(); }
        });
    },

    checkClick(lon, lat) {
        const rad = 2.5; 
        let hit = null;
        let type = '';

        if(Store.layers.public && Array.isArray(Store.data.pois)) {
            hit = Store.data.pois.find(p => Math.hypot(p.lon-lon, p.lat-lat) < rad);
            if(hit) type = 'public';
        }
        if(!hit && Store.layers.caves && Array.isArray(Store.data.caves)) {
            hit = Store.data.caves.find(p => Math.hypot(p.lon-lon, p.lat-lat) < rad);
            if(hit) type = 'caves';
        }
        
        if(hit) Ui.showInfo(hit, type);
    }
};

// --- DATA ---
window.Data = {
    async init() {
        try {
            const [c, i, t] = await Promise.all([
                fetchData(CFG.urlC), fetchData(CFG.urlI), fetchData(CFG.urlT)
            ]);
            
            if(!c) throw new Error("Config Error");
            Store.cfg = c;
            Store.icons = {...(i?.Items||{}), ...(i?.Kreaturen||{}), ...(i?.Ressourcen||{})};
            if(t) { Store.trans.dinos = t.Kreaturen||{}; Store.trans.res = t.Ressourcen||{}; }

            Ui.initSelector(c);
            this.loadMap('TheIsland');

        } catch(e) { console.error(e); logError("Init Failed"); }
    },

    async loadMap(k) {
        const l = document.getElementById('loader');
        if(l) l.classList.remove('hidden');
        
        Ui.setSpawnStatus('wait', 'Lade...');
        const c = Store.cfg[k];
        Store.map = c;
        Store.selDino = null; Store.activeRes.clear(); Store.activeObs.clear();
        MapEngine.reset();
        MapEngine.load(c.mapImageUrl);
        Ui.setStatus('map', 'ok');

        const urls = [
            c.creatureDataUrl, c.resourceDataUrl, c.publicSpotsDataUrl, c.obeliskDataUrl, c.caveSpotsDataUrl, c.playerSpawnDataUrl 
        ];
        
        const [d, r, p, o, ca, pl] = await Promise.all(urls.map(u => fetchData(u)));
        const processedSpawns = findSpawnGroups(pl);
        
        if (processedSpawns.length > 0) {
            Ui.setSpawnStatus('ok', `OK (${processedSpawns.length} Zonen)`);
            document.getElementById('tog-players').classList.remove('disabled');
        } else {
            Ui.setSpawnStatus('err', 'Keine Daten');
            document.getElementById('tog-players').classList.add('disabled');
        }

        Store.data = {
            dinos: d?.dinoSpawns||{}, res: r?.resources||{}, 
            pois: p?.publicSpots||[], obs: o?.obelisks||[], caves: ca?.caveSpots||[],
            players: processedSpawns 
        };

        Ui.renderDinos();
        Ui.renderRes();
        Ui.renderObs();
        Ui.resetToggles();
        MapEngine.draw();
    }
};

// --- UI ---
window.Ui = {
    initSelector(cfg) {
        const s = document.getElementById('map-select');
        Object.keys(cfg).forEach(k => {
            if(cfg[k].activated) {
                const o = document.createElement('option');
                o.value = k; o.textContent = cfg[k].displayName;
                s.appendChild(o);
            }
        });
        s.onchange = e => Data.loadMap(e.target.value);
    },
    
    toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    },
    
    // SIDEBAR TOGGLE
    toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const toggler = document.getElementById('sidebar-toggle');
        const isCollapsed = sb.classList.toggle('collapsed');
        
        toggler.innerHTML = isCollapsed ? '▶' : '◀';
        
        // Force Map Resize
        setTimeout(() => MapEngine.fit(), 310);
    },
    
    setSpawnStatus(type, msg) {
        const el = document.getElementById('st-spawn');
        const txt = document.getElementById('spawn-status');
        if(el) el.className = 'status-dot ' + type;
        if(txt) txt.textContent = msg;
    },
    
    setStatus(id, type) {}, 

    tab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const idx = ['dinos','res','pois'].indexOf(id);
        if(idx !== -1) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
        document.getElementById('view-'+id).classList.add('active');
        setTimeout(()=>MapEngine.fit(), 10);
    },

    // Reset visual toggle states when loading map
    resetToggles() {
        Store.layers = { public: false, caves: false, players: false };
        document.querySelectorAll('.toggle-item').forEach(el => el.classList.remove('checked'));
    },

    renderDinos(term="") {
        const l = document.getElementById('dino-list-root'); // CORRECT ID
        if(!l) return;
        const t = term.toLowerCase();
        const keys = Object.keys(Store.data.dinos).sort();
        const show = keys.filter(k => (Store.trans.dinos[k]||k).toLowerCase().includes(t));
        
        const items = (t ? show : show.slice(0, 50)).map(k => {
            const name = Store.trans.dinos[k]||k;
            const icon = Store.icons[k]?.iconUrl || 'https://placehold.co/24';
            const cls = Store.selDino === k ? 'selected' : '';
            return `<div class="select-item ${cls}" onclick="Ui.selectDino('${k}', '${name}')">
                <img src="${icon}"><span>${name}</span>
            </div>`;
        }).join('');
        l.innerHTML = items + (show.length > 50 && !t ? `<div class="text-xs text-center text-gray-500 p-2">... ${show.length-50} weitere ...</div>` : '');
    },

    toggleDinoDropdown() {
        const dd = document.getElementById('dino-dropdown-content');
        const trig = document.querySelector('.select-trigger');
        dd.classList.toggle('open');
        trig.classList.toggle('active');
        if(dd.classList.contains('open')) document.getElementById('search-dino').focus();
    },

    selectDino(key, name) {
        Store.selDino = key;
        document.getElementById('dino-trigger-text').textContent = name;
        this.toggleDinoDropdown();
        MapEngine.draw();
    },

    renderRes() {
        const l = document.getElementById('list-res');
        if(!l) return;
        l.innerHTML = Object.keys(Store.data.res).sort().map(k => {
            const iconUrl = Store.icons[k]?.iconUrl;
            // Always show checkbox container, insert icon if available
            const iconHtml = iconUrl ? `<img src="${iconUrl}" style="width:20px;height:20px;margin-right:8px;object-fit:contain;">` : '';
            
            return `<div class="toggle-item" onclick="Ui.togRes('${k}', this)">
                <div class="chk"></div>
                ${iconHtml}
                <span class="toggle-text">${Store.trans.res[k]||k}</span>
            </div>`;
        }).join('');
    },

    togRes(k, el) {
        if(Store.activeRes.has(k)) { Store.activeRes.delete(k); el.classList.remove('checked'); }
        else { Store.activeRes.add(k); el.classList.add('checked'); }
        MapEngine.draw();
    },

    renderObs() {
        const l = document.getElementById('list-obelisks');
        if(!l) return;
        l.innerHTML = Store.data.obs.map(o => `
            <div class="toggle-item" onclick="Ui.togObs('${o.name}', this)">
                <div class="chk"></div><span class="toggle-text">${o.name}</span>
            </div>`).join('');
    },

    togObs(k, el) {
        if(Store.activeObs.has(k)) { Store.activeObs.delete(k); el.classList.remove('checked'); }
        else { Store.activeObs.add(k); el.classList.add('checked'); }
        MapEngine.draw();
    },

    showInfo(data, type) {
        Store.selectedPOI = data;
        MapEngine.setMarker(data);
        document.getElementById('info-title').textContent = data.name || "INFO";
        let imgHtml = '';
        if (data.images && data.images.length > 0) imgHtml = `<img src="${data.images[0]}" class="w-full rounded border border-gray-700 mb-4 bg-black" onerror="this.style.display='none'">`;
        else if (data.icon) imgHtml = `<div class="flex justify-center mb-4"><img src="${data.icon}" class="w-16 h-16 object-contain"></div>`;
        const desc = data.longDescription || data.description || data.shortDescription || 'Keine Beschreibung verfügbar.';
        
        let listHtml = '';
        if (type) {
            const listTitle = type === 'public' ? 'ANDERE SPOTS' : 'ANDERE HÖHLEN';
            const sourceList = type === 'public' ? Store.data.pois : Store.data.caves;
            const listItems = sourceList.map(item => {
                const isActive = item === data ? 'active' : '';
                const idx = sourceList.indexOf(item);
                const fn = `Ui.selectFromList('${type}', ${idx})`;
                return `<div class="related-item ${isActive}" onclick="${fn}">${item.name}</div>`;
            }).join('');
            listHtml = `<div class="text-xs font-bold text-gray-500 mt-6 mb-2 tracking-wider">${listTitle}</div><div class="flex flex-col gap-1">${listItems}</div>`;
        }

        document.getElementById('info-body').innerHTML = `
            ${imgHtml}
            <div class="flex justify-center space-x-3 mb-4 text-xs font-mono text-gray-500 bg-black p-2 rounded border border-[#222]">
                <span>LAT: <span class="text-[#ff2a00]">${data.lat.toFixed(1)}</span></span>
                <span>LON: <span class="text-[#ff2a00]">${data.lon.toFixed(1)}</span></span>
            </div>
            <div class="text-sm text-gray-400 leading-relaxed whitespace-pre-wrap">${desc}</div>
            ${listHtml}
        `;
        const panel = document.getElementById('info-panel');
        panel.classList.add('visible');
        setTimeout(() => {
            const activeEl = panel.querySelector('.related-item.active');
            if(activeEl) activeEl.scrollIntoView({behavior: "smooth", block: "center"});
        }, 100);
    },
    
    selectFromList(type, index) {
        const sourceList = type === 'public' ? Store.data.pois : Store.data.caves;
        const item = sourceList[index];
        if(item) this.showInfo(item, type);
    },

    closeInfo() { 
        document.getElementById('info-panel').classList.remove('visible');
        MapEngine.setMarker(null);
        Store.selectedPOI = null;
    },

    toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 3000);
    }
};

window.Layers = {
    toggle(key) {
        Store.layers[key] = !Store.layers[key];
        document.getElementById('tog-'+key).classList.toggle('checked');
        MapEngine.draw();
    },
    
    // MASTER TOGGLES
    toggleAllPois() {
        const on = !Store.layers.public; 
        Store.layers.public = on;
        Store.layers.caves = on;
        ['tog-public', 'tog-caves', 'tog-all-pois'].forEach(id => {
            const el = document.getElementById(id);
            if(on) el.classList.add('checked'); else el.classList.remove('checked');
        });
        MapEngine.draw();
    }
};

window.Res = {
    clear() {
        Store.activeRes.clear();
        document.querySelectorAll('#list-res .toggle-item').forEach(e => e.classList.remove('checked'));
        document.getElementById('tog-all-res').classList.remove('checked');
        MapEngine.draw();
    },
    
    toggleAll() {
        const allKeys = Object.keys(Store.data.res);
        if (allKeys.length === 0) return;
        const allActive = Store.activeRes.size === allKeys.length;
        if (allActive) {
            this.clear();
        } else {
            allKeys.forEach(k => Store.activeRes.add(k));
            document.querySelectorAll('#list-res .toggle-item').forEach(e => e.classList.add('checked'));
            document.getElementById('tog-all-res').classList.add('checked');
            MapEngine.draw();
        }
    }
};

document.getElementById('search-dino').oninput = e => Ui.renderDinos(e.target.value);

document.addEventListener("DOMContentLoaded", () => {
    MapEngine.init(); 
    Data.init();
});

</script>
</body>
</html>
