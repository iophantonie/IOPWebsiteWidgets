<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IOP Cluster Explorer v46.0 (Spawn Harvester)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Acme&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL STYLES --- */
        :root {
            --color-red: #E53935; --color-dark: rgba(20, 20, 20, 0.95); --color-text: #f7f7f7;
            --phoenix-gold: #FFEB3B; --sidebar-width: 320px; --nav-width: 280px;
            --phoenix-fire: #ff2a00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: transparent; font-family: 'Segoe UI', sans-serif; color: var(--color-text); overflow: hidden; }

        .map-widget-container { background-color: var(--color-dark); border-radius: 12px; border: 3px solid var(--color-red); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.8); width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        .main-page-header { font-size: 2.5rem; font-weight: 800; color: var(--color-red); font-family: 'Acme', sans-serif; text-transform: uppercase; text-align: center; padding: 15px 0; margin: 0; text-shadow: 0 0 20px rgba(229, 57, 53, 0.4); border-bottom: 3px solid var(--color-red); background-color: rgba(0, 0, 0, 0.2); flex-shrink: 0; z-index: 60; display: flex; justify-content: center; align-items: center; position: relative; }
        .header-controls { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; gap: 10px; }
        .btn-header { padding: 5px 15px; border: 1px solid #666; background: #222; color: #ccc; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; font-family: sans-serif; font-size: 0.8rem; text-decoration: none; display: flex; align-items: center; }
        .btn-header:hover { border-color: var(--color-red); color: var(--color-red); background: #333; }
        .btn-live { border-color: #ef4444; color: #ef4444; animation: pulse-red 2s infinite; }
        .btn-live:hover { background: #ef4444; color: white; }
        .live-active { background: #ef4444 !important; color: white !important; animation: none !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .map-body-wrapper { display: flex; flex-direction: row; flex-grow: 1; width: 100%; overflow: hidden; }

        .map-sidebar { width: var(--nav-width); background-color: rgba(0, 0, 0, 0.4); border-right: 2px solid var(--color-red); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; z-index: 55; scrollbar-width: thin; scrollbar-color: var(--color-red) transparent; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 3px solid var(--color-red); background-color: rgba(229, 57, 53, 0.1); }
        .sidebar-title { font-family: 'Acme', sans-serif; font-size: 1.4rem; color: var(--color-text); text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .sidebar-subtitle { font-size: 0.8rem; color: var(--color-red); opacity: 0.8; margin-top: 5px; }

        .map-btn { background: transparent; border: none; color: rgba(255, 255, 255, 0.7); padding: 12px 20px; text-align: left; cursor: pointer; font-size: 1rem; font-family: sans-serif; transition: all 0.2s ease; border-left: 4px solid transparent; display: flex; justify-content: space-between; align-items: center; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .map-btn:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; padding-left: 25px; }
        .map-btn.active { background-color: rgba(229, 57, 53, 0.15); color: #fff; border-left-color: var(--color-red); font-weight: 600; }
        .status-dot { height: 8px; width: 8px; background-color: #4CAF50; border-radius: 50%; box-shadow: 0 0 5px #4CAF50; }

        .iframe-wrapper { flex-grow: 1; position: relative; background-color: #121212; display: flex; overflow: hidden; }

        #tool-sidebar { width: var(--sidebar-width); height: 100%; background: #0a0a0a; border-right: 1px solid #333; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; transition: margin-left 0.3s ease; position: relative; }
        #tool-sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        #tool-toggle { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 20px; height: 50px; background: #111; border: 1px solid #444; border-left: none; border-radius: 0 6px 6px 0; cursor: pointer; z-index: 45; display: flex; align-items: center; justify-content: center; color: #888; transition: left 0.3s ease; }
        #tool-sidebar:not(.collapsed) + #tool-toggle { left: var(--sidebar-width); }
        #tool-toggle:hover { color: var(--color-red); }
        .tool-header { padding: 10px 15px; background: #000; border-bottom: 2px solid var(--color-red); color: #888; font-weight: bold; font-size: 0.8rem; letter-spacing: 0.1em; }
        
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 10px; color: #777; font-size: 0.75rem; font-weight: 700; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: var(--color-red); border-color: var(--color-red); background: linear-gradient(to top, rgba(229, 57, 53, 0.1), transparent); }
        .sb-content { flex: 1; overflow-y: auto; padding: 15px; scrollbar-width: thin; scrollbar-color: #333 #0a0a0a; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }

        #viewport { flex: 1; position: relative; background: #050505; overflow: hidden; }
        #world { position: absolute; top: 0; left: 0; width: 1024px; height: 1024px; box-shadow: 0 0 100px rgba(0,0,0,0.5); transform-origin: 0 0; will-change: transform; }
        #map-image-layer { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: fill; pointer-events: none; }
        #data-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        #input-layer { position: absolute; inset: 0; width: 100%; height: 100%; cursor: grab; z-index: 10; }
        #input-layer:active { cursor: grabbing; }

        #live-map-frame { position: absolute; inset: 0; width: 100%; height: 100%; border: none; z-index: 100; background: #000; }
        .live-mode-active #world, .live-mode-active .map-legend, .live-mode-active .hud-bot, .live-mode-active #coords-display { display: none !important; }
        .live-mode-active #tool-sidebar { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        .toggle-item { display: flex; align-items: center; padding: 6px 0; cursor: pointer; user-select: none; }
        .chk { width: 16px; height: 16px; border: 2px solid #444; border-radius: 3px; margin-right: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: #000; }
        .toggle-item.checked .chk { background: var(--color-red); border-color: var(--color-red); }
        .toggle-item.checked .chk::after { content: '‚úì'; color: black; font-weight: bold; font-size: 10px; }
        .custom-select { position: relative; }
        .select-trigger { background: #151515; border: 1px solid #444; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .select-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: #111; border: 1px solid #444; max-height: 300px; overflow-y: auto; z-index: 100; display: none; }
        .select-dropdown.open { display: block; }
        .select-search input { width: 100%; background: #222; border: 1px solid #444; padding: 6px; border-radius: 4px; color: white; outline: none; }
        .select-item { display: flex; align-items: center; padding: 8px; cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        .select-item:hover { background: #1a1a1a; }
        .select-item.selected { background: rgba(229, 57, 53, 0.15); border-left: 3px solid var(--color-red); }
        .select-item img { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }

        .map-legend { position: absolute; bottom: 20px; left: 20px; width: 160px; background: rgba(10,10,10,0.9); border: 1px solid #333; border-left: 3px solid var(--color-red); padding: 10px; z-index: 50; font-size: 10px; color: #ccc; pointer-events: none; }
        .leg-item { display: flex; align-items: center; margin-bottom: 2px; }
        .leg-box { width: 10px; height: 10px; margin-right: 8px; }
        .hud-bot { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 8px; z-index: 50; }
        .zoom-btn { width: 40px; height: 40px; background: #111; border: 1px solid #444; color: white; border-radius: 6px; font-size: 20px; cursor: pointer; display: grid; place-items: center; }
        .zoom-btn:hover { border-color: var(--color-red); color: var(--color-red); }
        #coords-display { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.9); padding: 5px 10px; border-radius: 4px; font-family: monospace; font-size: 0.9rem; border: 1px solid #333; color: var(--phoenix-gold); z-index: 50; pointer-events: none; }

        .pulse-marker { position: absolute; width: 60px; height: 60px; border: 2px solid var(--phoenix-fire); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--phoenix-fire), inset 0 0 10px var(--phoenix-fire); z-index: 50; pointer-events: none; animation: pulse 2s infinite; display: none; }
        @keyframes pulse { 0% {transform:translate(-50%,-50%) scale(0.5);opacity:1} 100% {transform:translate(-50%,-50%) scale(1.5);opacity:0} }

        .info-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 340px; background: #0a0a0a; border-left: 1px solid var(--color-red); transform: translateX(100%); transition: transform 0.3s; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.9); display: flex; flex-direction: column; }
        .info-panel.visible { transform: translateX(0); }
        .info-header { padding: 15px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .info-title { font-size: 1.0rem; font-weight: 800; color: #fff; text-transform: uppercase; font-family: 'Acme', sans-serif; }
        .info-close { color: #888; cursor: pointer; font-size: 1.5rem; transition: 0.2s; } .info-close:hover { color: var(--color-red); }

        .modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-card { background: #0a0a0a; border: 1px solid #333; border-left: 3px solid var(--color-red); width: 90%; max-width: 900px; height: 90%; display: flex; flex-direction: column; position: relative; border-radius: 8px; overflow: hidden; }
        .modal-close { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; background: rgba(0,0,0,0.8); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #444; cursor: pointer; z-index: 60; font-size: 20px; }
        .modal-close:hover { border-color: var(--color-red); color: var(--color-red); }
        .modal-img-container { width: 100%; height: 50%; background: #000; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #333; position: relative; flex-shrink: 0; }
        .modal-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-body { padding: 25px; flex: 1; overflow-y: auto; }
        .modal-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; transition: 0.2s; border: 1px solid transparent; z-index: 50; }
        .modal-nav-btn:hover { background: rgba(0,0,0,0.9); border-color: var(--color-red); color: var(--color-red); }
        .nav-prev { left: 20px; } .nav-next { right: 20px; }
        .img-counter { position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.7); color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: monospace; }
        .img-overlay-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: var(--phoenix-gold); padding: 5px 10px; border-radius: 4px; border: 1px solid var(--phoenix-gold); font-size: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .img-overlay-btn:hover { background: var(--phoenix-gold); color: black; }
        
        .artifact-row { display: flex; align-items: center; margin-bottom: 5px; background: rgba(229, 57, 53, 0.1); padding: 8px; border: 1px solid var(--color-red); border-radius: 4px; color: var(--color-red); font-weight: bold; font-size: 0.85rem; }
        .artifact-icon { width: 36px; height: 36px; margin-right: 10px; object-fit: contain; }
        .modal-artifact-row { display: inline-block; margin: 5px; background: rgba(229, 57, 53, 0.1); padding: 6px 12px; border: 1px solid var(--color-red); border-radius: 4px; color: var(--color-red); font-weight: bold; font-size: 0.9rem; }
        
        .related-item { padding: 8px 10px; cursor: pointer; border-radius: 4px; font-size: 0.85rem; color: #ccc; border: 1px solid #222; border-left: 3px solid transparent; background: #161616; transition: all 0.2s; margin-bottom: 2px; }
        .related-item:hover { background: #222; color: white; border-left-color: #666; transform: translateX(2px); }
        .related-item.active { background: rgba(255, 42, 0, 0.1); border-left-color: var(--color-red); color: var(--color-red); font-weight: bold; border-color: rgba(255, 42, 0, 0.2); }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .info-card { background: #161616; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        .info-card h4 { color: var(--color-gold); font-size: 0.8rem; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .info-tag { display: inline-block; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin: 2px; color: #ccc; }

        .loader { position: absolute; inset: 0; background: #000; z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top-color: var(--color-red); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        #error-log { position: absolute; top: 0; left: 0; width: 100%; background: rgba(220, 38, 38, 0.95); color: white; padding: 5px; font-size: 11px; z-index: 10000; display: none; text-align: center; }

        @media (max-width: 900px) {
            .map-body-wrapper { flex-direction: column; }
            .map-sidebar { width: 100%; height: 200px; border-right: none; border-bottom: 2px solid var(--color-red); }
            #tool-sidebar { position: absolute; top: 0; bottom: 0; left: 0; transform: translateX(-100%); width: 280px; }
            #tool-sidebar.mobile-open { transform: translateX(0); }
            #mobile-menu-btn { display: block; position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.8); color: white; padding: 5px; border-radius: 4px; cursor: pointer; }
            #tool-toggle { display: none; }
        }
        #mobile-menu-btn { display: none; }
    </style>
</head>
<body>

<div id="error-log"></div>
<div id="loader" class="loader"><div class="spinner mb-4"></div><div id="loader-msg" class="text-white font-bold text-sm tracking-widest uppercase">Lade System...</div></div>

<div class="map-widget-container">
    <!-- HEADER -->
    <div class="main-page-header">
        Kartographie
        <div class="header-controls">
            <button id="live-map-btn" onclick="Ui.toggleLiveMode()" class="hidden btn-header btn-live">LIVE</button>
            <button id="map-info-btn" onclick="Ui.showMapInfo()" class="hidden btn-header">INFO</button>
            <a href="https://infinityofphoenix-asa.com" target="_top" class="btn-header">‚åÇ HOME</a>
        </div>
    </div>

    <div class="map-body-wrapper">
        <!-- LEFT NAV -->
        <div class="map-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Cluster Explorer</h2>
                <div class="sidebar-subtitle">W√§hle eine Karte</div>
            </div>
            
            <div id="map-list-container" class="flex-1 overflow-y-auto"></div>
        </div>

        <!-- RIGHT EXPLORER -->
        <div class="iframe-wrapper" id="explorer-engine">
            <div id="mobile-menu-btn" onclick="Ui.toggleToolSidebar()">‚öô</div>

            <!-- TOOL SIDEBAR -->
            <div id="tool-sidebar">
                <div class="tool-header">
                    <span class="tool-title">WERKZEUGE</span>
                </div>
                <nav class="tabs">
                    <button class="tab-btn active" onclick="Ui.tab('dinos')">DINOS</button>
                    <button class="tab-btn" onclick="Ui.tab('res')">RES.</button>
                    <button class="tab-btn" onclick="Ui.tab('pois')">ORTE</button>
                </nav>
                <div class="sb-content">
                    <!-- DINOS -->
                    <div id="view-dinos" class="view active">
                        <div class="custom-select" id="dino-dropdown">
                            <div class="select-trigger" onclick="Ui.toggleDinoDropdown()">
                                <span id="dino-trigger-text" class="truncate">W√§hle Dino...</span>
                                <div class="flex items-center"><span id="dino-clear-btn" class="text-xs text-gray-500 hover:text-white mr-2 hidden px-2 cursor-pointer" onclick="event.stopPropagation(); Ui.clearDino()">‚úï</span><span>‚ñº</span></div>
                            </div>
                            <div id="dino-dropdown-content" class="select-dropdown">
                                <div class="p-2 bg-[#111] sticky top-0 border-b border-gray-700"><input type="text" id="search-dino" placeholder="Suche..." class="select-search" autocomplete="off"></div>
                                <div id="dino-list-root"></div>
                            </div>
                        </div>
                    </div>
                    <!-- RES -->
                    <div id="view-res" class="view">
                        <div class="mb-4 border-b border-gray-800 pb-2"><div class="toggle-item" id="tog-all-res" onclick="Res.toggleAll()"><div class="chk"></div><span class="text-xs font-bold text-gray-500 tracking-wider">ALLE RESSOURCEN</span></div></div>
                        <div id="list-res"></div>
                    </div>
                    <!-- POIS -->
                    <div id="view-pois" class="view">
                        <div class="mb-6">
                            <div class="toggle-item mb-2" id="tog-all-pois" onclick="Layers.toggleAllPois()"><div class="chk"></div><span class="text-amber-500 text-sm font-bold">Alle Orte einblenden</span></div>
                            <div id="region-container" class="hidden mb-2 pl-4 border-l-2 border-[#1a1a1a] ml-1">
                                <div class="text-[10px] text-gray-600 font-bold mb-1 mt-2 uppercase tracking-wider">Regionen</div>
                                <div class="toggle-item mb-2" id="tog-all-regions" onclick="Reg.toggleAll()"><div class="chk"></div><span class="text-xs font-bold text-gray-400">Alle Regionen</span></div>
                                <div id="list-regions"></div>
                            </div>
                            <div class="pl-4 border-l-2 border-[#1a1a1a] ml-1 mt-2">
                                <div class="toggle-item" id="tog-public" onclick="Layers.toggle('public')"><div class="chk"></div><span>Public Spots</span></div>
                                <div class="toggle-item" id="tog-caves" onclick="Layers.toggle('caves')"><div class="chk"></div><span>H√∂hlen</span></div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">SPAWNS</div>
                            <div class="toggle-item" id="tog-players" onclick="Layers.toggle('players')"><div class="chk"></div><span>Spieler Spawns</span></div>
                            <div class="text-xs text-red-500 ml-8 mt-1 italic flex items-center"><span id="spawn-msg"></span></div>
                        </div>
                        <div><div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">OBELISKEN</div><div class="toggle-item mb-2" id="tog-all-obs" onclick="Obs.toggleAll()"><div class="chk"></div><span class="text-xs font-bold text-gray-400">Alle Obelisken</span></div><div id="list-obelisks"></div></div>
                    </div>
                </div>
            </div>
            
            <div id="tool-toggle" onclick="Ui.toggleToolSidebar()">‚óÄ</div>

            <!-- MAP CANVAS -->
            <div id="viewport">
                <iframe id="live-map-frame" class="hidden z-20" frameborder="0"></iframe>
                <div class="map-legend">
                    <div class="font-bold text-amber-500 mb-2 uppercase text-[10px]">Spawn Raten</div>
                    <div class="leg-item"><div class="leg-box" style="background:#22c55e"></div>Sehr H√§ufig</div>
                    <div class="leg-item"><div class="leg-box" style="background:#84cc16"></div>H√§ufig</div>
                    <div class="leg-item"><div class="leg-box" style="background:#eab308"></div>Gelegentlich</div>
                    <div class="leg-item"><div class="leg-box" style="background:#f97316"></div>Selten</div>
                    <div class="leg-item"><div class="leg-box" style="background:#ef4444"></div>Sehr Selten</div>
                    <div class="leg-item"><div class="leg-box" style="background:#a855f7"></div>Extrem Selten</div>
                    <div class="leg-item mt-2"><div class="leg-box" style="background:repeating-linear-gradient(45deg,#fff2,#fff2 2px,transparent 2px,transparent 4px);border:1px solid #777"></div>H√∂hle</div>
                </div>
                <div id="world">
                    <img id="map-image-layer" src="" alt="Karte">
                    <canvas id="data-canvas"></canvas>
                    <div id="selection-marker" class="pulse-marker"></div>
                    <div id="input-layer"></div>
                </div>
                <div id="coords-display">LAT: <span id="lat">00.0</span> | LON: <span id="lon">00.0</span></div>
                <div class="hud-bot"><button class="zoom-btn" onclick="Ui.toggleFullscreen()">‚õ∂</button><button class="zoom-btn" onclick="MapEngine.reset()">‚ü≤</button></div>
            </div>

            <!-- POPUPS & MODALS -->
            <div id="info-panel" class="info-panel"><div class="info-header"><h2 id="info-title" class="text-lg font-bold text-white truncate">Info</h2><button onclick="Ui.closeInfo()" class="info-close">√ó</button></div><div id="info-body" class="p-5 text-sm text-gray-300 overflow-y-auto h-full"></div></div>

            <div id="detail-modal" class="modal-overlay" onclick="if(event.target===this) Ui.closeDetail()">
                <div class="modal-card">
                    <button class="modal-close" onclick="Ui.closeDetail()">√ó</button>
                    <div class="modal-img-container"><img id="detail-img" class="modal-img" alt=""><div id="gal-prev" class="modal-nav-btn nav-prev" onclick="Ui.prevImg()">‚ùÆ</div><div id="gal-next" class="modal-nav-btn nav-next" onclick="Ui.nextImg()">‚ùØ</div><div id="gal-count" class="img-counter"></div></div>
                    <div class="modal-body"><div class="flex justify-between border-b border-gray-800 pb-4 mb-4"><h2 id="detail-title" class="text-2xl font-black text-white uppercase"></h2><div class="text-right text-phoenix-gold font-mono font-bold"><span id="detail-lat"></span> / <span id="detail-lon"></span></div></div><div id="detail-desc" class="text-gray-300 leading-relaxed mb-6 whitespace-pre-wrap"></div><div id="detail-artifacts"></div></div>
                </div>
            </div>

            <div id="map-info-modal" class="modal-overlay" onclick="if(event.target===this) Ui.closeMapInfo()">
                <div class="modal-card" style="max-width: 800px; height: auto; max-height: 90%;">
                    <button class="modal-close" onclick="Ui.closeMapInfo()">√ó</button>
                    <div class="p-6 bg-[#0a0a0a] overflow-y-auto">
                        <h2 class="text-2xl font-black text-white uppercase mb-4 border-b border-gray-800 pb-2">Karten Informationen</h2>
                        <div id="map-info-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// CONFIG
const CFG = {
    urlC: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/MapConfigs/MapConfigs.jsn',
    urlI: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/refs/heads/main/Icon_Datenbank/Icondb.jsn',
    urlT: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Translation_Datenbank/translationdb.jsn',
    urlShare: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/SpawnSharingConfig/spawnsharing.jsn',
    urlBlock: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Blocked_Zones_Datenbank/blockedzonesdb.jsn',
    urlAlpha: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Alpha_Listen_Datenbank/alphalistdb.jsn',
    col: { spawn: 'rgba(255, 42, 0, 0.4)', stroke: '#ff2a00' },
    rarity: [{th:0.10,c:'#22c55e'},{th:0.05,c:'#84cc16'},{th:0.02,c:'#eab308'},{th:0.01,c:'#f97316'},{th:0.001,c:'#ef4444'},{th:0,c:'#a855f7'}]
};

function fixUrl(url) { if(!url) return ''; if(url.includes('github.com')&&url.includes('/blob/')) return url.replace('github.com','raw.githubusercontent.com').replace('/blob/','/'); return url; }
function hexToRgba(h,a) { const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }
async function fetchJson(url) { try { const r=await fetch(fixUrl(url)); if(!r.ok) throw new Error("HTTP "+r.status); const t=await r.text(); return JSON.parse(t.replace(/^\uFEFF/,'').replace(/\u00A0/g,' ')); } catch(e) { return null; } }
function safeCoord(v) { if(v===undefined||v===null) return 0; if(typeof v==='number') return v; return parseFloat(v.toString().replace(',','.')); }

// --- DATA HARVESTERS ---

// SPAWNS: Collect EVERYTHING that looks like a point
function findSpawns(data) {
    if(!data) return [];
    
    // 1. Structure Match (Array of Groups)
    if(Array.isArray(data) && data.length > 0) {
        if(data[0].spawnPoints || data[0].locations || data[0].spawns) return data; // Keep structure
    }

    // 2. Deep Harvest: Flatten everything to points
    let collected = [];
    const harvest = (o) => {
        if(!o || typeof o !== 'object') return;
        const lat = o.lat !== undefined ? o.lat : o.latitude;
        const lon = o.lon !== undefined ? o.lon : o.longitude;
        if(lat !== undefined && lon !== undefined) {
             collected.push({ lat: lat, lon: lon, name: o.name });
        }
        Object.values(o).forEach(harvest);
    };
    harvest(data);
    
    if(collected.length > 0) return [{ name: "Player Spawns", color: "#4ade80", locations: collected }];
    return [];
}

function isBlocked(z, mapId) {
    const list = Store.blocked[mapId]; if(!list||!Array.isArray(list)) return false;
    const zMinX = safeCoord(z.min.lon), zMaxX = safeCoord(z.max.lon), zMinY = safeCoord(z.min.lat), zMaxY = safeCoord(z.max.lat);
    return list.some(b => {
        if(typeof b === 'string') {
            const m = b.match(/lat([\d\.]+)-([\d\.]+)_lon([\d\.]+)-([\d\.]+)/);
            if(m) {
                const bMinLat=parseFloat(m[1]), bMaxLat=parseFloat(m[2]), bMinLon=parseFloat(m[3]), bMaxLon=parseFloat(m[4]);
                return !(zMaxX < bMinLon || zMinX > bMaxLon || zMaxY < bMinLat || zMinY > bMaxLat);
            }
        }
        return false;
    });
}

// GLOBAL OBJECTS
window.Layers = {
    toggle(k) { Store.layers[k]=!Store.layers[k]; document.getElementById('tog-'+k).classList.toggle('checked'); MapEngine.draw(); },
    toggleAllPois() {
        const on = !Store.layers.public; Store.layers.public = on; Store.layers.caves = on;
        ['tog-public','tog-caves','tog-all-pois'].forEach(id => { const el = document.getElementById(id); if(el) { if(on) el.classList.add('checked'); else el.classList.remove('checked'); } });
        MapEngine.draw();
    }
};

window.Res = {
    clear() { Store.activeRes.clear(); document.querySelectorAll('#list-res .toggle-item').forEach(e => e.classList.remove('checked')); document.getElementById('tog-all-res').classList.remove('checked'); MapEngine.draw(); },
    toggleAll() {
        const allKeys = Object.keys(Store.data.res);
        if(!allKeys.length) return;
        const on = Store.activeRes.size !== allKeys.length;
        if(on) { allKeys.forEach(k => Store.activeRes.add(k)); document.querySelectorAll('#list-res .toggle-item').forEach(e => e.classList.add('checked')); document.getElementById('tog-all-res').classList.add('checked'); } 
        else { this.clear(); }
        MapEngine.draw();
    }
};

window.Obs = {
    toggleAll() {
        const allKeys = Store.data.obs.map(o => o.name);
        if(!allKeys.length) return;
        const on = Store.activeObs.size !== allKeys.length;
        if(on) { allKeys.forEach(k => Store.activeObs.add(k)); document.querySelectorAll('#list-obelisks .toggle-item').forEach(e => e.classList.add('checked')); document.getElementById('tog-all-obs').classList.add('checked'); } 
        else { Store.activeObs.clear(); document.querySelectorAll('#list-obelisks .toggle-item').forEach(e => e.classList.remove('checked')); document.getElementById('tog-all-obs').classList.remove('checked'); }
        MapEngine.draw();
    }
};

window.Reg = {
    toggleAll() {
        const allKeys = Store.data.regions.map(r => r.id);
        if(!allKeys.length) return;
        const on = Store.activeRegions.size !== allKeys.length;
        if(on) { allKeys.forEach(k => Store.activeRegions.add(k)); document.querySelectorAll('#list-regions .toggle-item').forEach(e => e.classList.add('checked')); document.getElementById('tog-all-regions').classList.add('checked'); } 
        else { Store.activeRegions.clear(); document.querySelectorAll('#list-regions .toggle-item').forEach(e => e.classList.remove('checked')); document.getElementById('tog-all-regions').classList.remove('checked'); }
        MapEngine.draw();
    }
};

const Store = { cfg: {}, map: null, dom: { mapImg: null }, data: { dinos:{}, res:{}, pois:[], obs:[], caves:[], players:[], regions:[], mapInfo: null }, icons: {}, trans: {d:{}, r:{}}, sharing: {}, blocked: {}, alphas: {}, selDino: null, selectedPOI: null, activeRes: new Set(), activeObs: new Set(), activeRegions: new Set(), layers: { public: false, caves: false, players: false }, view: { x:0, y:0, scale:1 }, sidebarOpen: true, mapKey: null, currentImgIdx: 0, liveMode: false };

window.MapEngine = {
    el: null, cvs: null, ctx: null, img: null, marker: null, iconCache: new Map(), pattern: null, cavePattern: null,
    isDown: false, startX: 0, startY: 0, moved: false, resizeObserver: null,
    init() {
        this.el=document.getElementById('world'); this.img=document.getElementById('map-image-layer'); this.cvs=document.getElementById('data-canvas'); this.marker=document.getElementById('selection-marker'); this.ctx=this.cvs.getContext('2d'); Store.dom.mapImg=this.img;
        const p=document.createElement('canvas'); p.width=10; p.height=10; const pc=p.getContext('2d'); pc.strokeStyle='rgba(255,255,255,0.3)'; pc.lineWidth=1; pc.beginPath(); pc.moveTo(0,10); pc.lineTo(10,0); pc.stroke(); this.cavePattern=this.ctx.createPattern(p,'repeat');
        const input=document.getElementById('input-layer');
        input.onmousedown=e=>{ 
            this.isDown=true; this.moved=false; this.startX=e.clientX; this.startY=e.clientY; input.style.cursor='grabbing';
            document.getElementById('dino-dropdown-content').classList.remove('open'); 
            document.querySelector('.select-trigger').classList.remove('active');
        };
        window.onmouseup=()=>{ this.isDown=false; input.style.cursor='grab'; };
        input.onmousemove=e=>{
            if(this.isDown) { const dx=e.clientX-this.startX, dy=e.clientY-this.startY; if(Math.abs(dx)>2||Math.abs(dy)>2) { this.moved=true; Store.view.x+=dx; Store.view.y+=dy; this.startX=e.clientX; this.startY=e.clientY; this.update(); } }
            const r=this.el.getBoundingClientRect(); document.getElementById('lat').innerText=Math.max(0,Math.min(100,((e.clientY-r.top)/r.height)*100)).toFixed(1); document.getElementById('lon').innerText=Math.max(0,Math.min(100,((e.clientX-r.left)/r.width)*100)).toFixed(1);
        };
        input.onwheel=e=>{ e.preventDefault(); const r=this.el.getBoundingClientRect(); this.zoomAt(e.deltaY>0?0.9:1.1, e.clientX-r.left, e.clientY-r.top); };
        input.onclick=e=>{ if(this.moved) return; const r=this.el.getBoundingClientRect(); this.click(((e.clientX-r.left)/r.width)*100, ((e.clientY-r.top)/r.height)*100); };
        new ResizeObserver(()=>this.fit()).observe(document.getElementById('viewport')); setTimeout(()=>this.fit(), 100);
    },
    fit() { if(!this.el) return; const vp=document.getElementById('viewport'); const s=Math.min(vp.clientWidth, vp.clientHeight); const size=Math.max(100,s); this.el.style.width=size+'px'; this.el.style.height=size+'px'; this.cvs.width=size; this.cvs.height=size; this.el.style.left=(vp.clientWidth-size)/2+'px'; this.el.style.top=(vp.clientHeight-size)/2+'px'; this.draw(); },
    load(url) { const safe=fixUrl(url); this.img.src=safe; document.getElementById('loader').classList.remove('hidden'); this.img.onload=()=>{ document.getElementById('loader').classList.add('hidden'); this.fit(); this.draw(); }; this.img.onerror=()=>{ document.getElementById('error-log').innerText="Bild Fehler: "+safe; document.getElementById('loader').classList.add('hidden'); }; this.setMarker(null); },
    update() { if(this.el) this.el.style.transform=`translate(${Store.view.x}px, ${Store.view.y}px) scale(${Store.view.scale})`; },
    zoomAt(f,mx,my) { const os=Store.view.scale, ns=Math.max(0.5,Math.min(10,os*f)); if(os===ns) return; Store.view.x+=mx-(mx*(ns/os)); Store.view.y+=my-(my*(ns/os)); Store.view.scale=ns; this.update(); },
    reset() { Store.view.scale=1; Store.view.x=0; Store.view.y=0; this.update(); this.fit(); },
    setMarker(d) { if(!d) { this.marker.style.display='none'; return; } this.marker.style.left=d.lon+'%'; this.marker.style.top=d.lat+'%'; this.marker.style.display='block'; },
    
    // ICON LOADER
    getImg(url) { if(!url) return null; const s=fixUrl(url); if(this.iconCache.has(s)) return this.iconCache.get(s); const i=new Image(); i.src=s; i.onload=()=>this.draw(); this.iconCache.set(s,i); return i; },
    getIcon(k) {
        if(!k) return null;
        if(k.includes('http') || k.includes('github') || k.includes('/')) return this.getImg(k);
        return this.getImg(Store.icons[k]?.iconUrl); 
    },
    
    draw() {
        if(!this.ctx) return; const w=this.cvs.width, h=this.cvs.height, ctx=this.ctx; ctx.clearRect(0,0,w,h);
        
        // Regions
        Store.activeRegions.forEach(id=>{ const r=Store.data.regions.find(x=>x.id==id); if(r&&r.imageUrl) { const i=this.getImg(r.imageUrl); if(i&&i.complete) { ctx.save(); ctx.shadowColor=r.color||'#fff'; ctx.shadowBlur=20; ctx.drawImage(i,0,0,w,h); ctx.restore(); } } });
        
        // Dinos
        if(Store.selDino&&Store.data.dinos[Store.selDino]) { Store.data.dinos[Store.selDino].forEach(z=>{ if(isBlocked(z,Store.mapKey)) return; const x=(safeCoord(z.min.lon)/100)*w, y=(safeCoord(z.min.lat)/100)*h, zw=((safeCoord(z.max.lon)-safeCoord(z.min.lon))/100)*w, zh=((safeCoord(z.max.lat)-safeCoord(z.min.lat))/100)*h; let col='#22c55e'; const sc=(parseFloat(z.chance)||0.5)*(parseFloat(z.weight)||1); for(let r of CFG.rarity) if(sc>=r.th) { col=r.c; break; } if(z.isCave||z.cave) { ctx.fillStyle=this.cavePattern; ctx.fillRect(x,y,zw,zh); } else { ctx.fillStyle=hexToRgba(col,0.4); ctx.fillRect(x,y,zw,zh); } ctx.strokeStyle=col; ctx.lineWidth=2; ctx.strokeRect(x,y,zw,zh); }); }
        
        // Res (FALLBACK CIRCLE)
        Store.activeRes.forEach(k=>{ if(Store.data.res[k]) { const i=this.getIcon(k), c={'Metal':'#b87333'}[k]||'#fff'; Store.data.res[k].forEach(p=>{ const cx=(safeCoord(p.lon)/100)*w, cy=(safeCoord(p.lat)/100)*h, sz=Math.min(32,12+((p.size||1)*2)); if(i&&i.complete&&i.naturalWidth>0) ctx.drawImage(i,cx-sz/2,cy-sz/2,sz,sz); else { ctx.fillStyle=c; ctx.beginPath(); ctx.arc(cx,cy,4,0,2*Math.PI); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#fff'; ctx.stroke(); } }); } });
        
        // POI (FALLBACK CIRCLE)
        if(Store.layers.public) this.drawList(Store.data.pois,w,h,'#ff2a00');
        if(Store.layers.caves) this.drawList(Store.data.caves,w,h,'#a855f7');
        
        // Obs (FALLBACK CIRCLE)
        Store.activeObs.forEach(k=>{ 
            const o=Store.data.obs.find(i=>i.name===k); 
            if(o) { 
                let i=this.getIcon(o.icon)||this.getIcon(o.name); 
                const cx=(safeCoord(o.lon)/100)*w, cy=(safeCoord(o.lat)/100)*h; 
                if(i&&i.complete&&i.naturalWidth>0) { const ht=60, ar=i.naturalWidth/i.naturalHeight; ctx.drawImage(i,cx-(ht*ar)/2,cy-ht,ht*ar,ht); } 
                else { ctx.fillStyle='#0000ff'; ctx.beginPath(); ctx.arc(cx,cy,8,0,2*Math.PI); ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke(); } 
            } 
        });
        
        // Players (NORMALIZED & ROBUST)
        if(Store.layers.players && Store.data.players.length) { 
            const pal=['#4ade80','#60a5fa','#facc15','#f87171']; 
            Store.data.players.forEach((g,i)=>{ 
                ctx.fillStyle=g.color||pal[i%4]; 
                ctx.strokeStyle='#000'; // Black border for better visibility
                ctx.lineWidth=2; 
                // Flexible accessor
                const locs = g.locations || g.spawnPoints || g.spawns || [];
                locs.forEach(p=>{ 
                    const lat = safeCoord(p.lat !== undefined ? p.lat : p.latitude);
                    const lon = safeCoord(p.lon !== undefined ? p.lon : p.longitude);
                    if(lat !== 0 && lon !== 0) {
                        const cx=(lon/100)*w, cy=(lat/100)*h; 
                        ctx.beginPath(); ctx.arc(cx,cy,5,0,2*Math.PI); ctx.fill(); ctx.stroke(); 
                    }
                }); 
            }); 
        }
    },
    drawList(l,w,h,c) { if(!l) return; const ctx=this.ctx; l.forEach(p=>{ const cx=(safeCoord(p.lon)/100)*w, cy=(safeCoord(p.lat)/100)*h, i=this.getIcon(p.icon)||this.getIcon(p.name); if(i&&i.complete&&i.naturalWidth>0) ctx.drawImage(i,cx-16,cy-16,32,32); else { ctx.fillStyle=c; ctx.beginPath(); ctx.arc(cx,cy,6,0,2*Math.PI); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#fff'; ctx.stroke(); } }); },
    click(lon,lat) {
        const r=2.5; let h=null, t='';
        if(Store.layers.public) { h=Store.data.pois.find(p=>Math.hypot(p.lon-lon,p.lat-lat)<r); if(h) t='public'; }
        if(!h&&Store.layers.caves) { h=Store.data.caves.find(p=>Math.hypot(p.lon-lon,p.lat-lat)<r); if(h) t='caves'; }
        if(h) Ui.showInfo(h,t);
        else {
             Store.activeRes.forEach(k=>{ if(Store.data.res[k]) { const p=Store.data.res[k].find(pt=>Math.hypot(pt.lon-lon,pt.lat-lat)<r); if(p) { Ui.showInfo({name:Store.trans.res[k]||k,lat:p.lat,lon:p.lon,description:"Ressource"},'res'); h=true; } } });
             if(!h) Store.activeObs.forEach(k=>{ const o=Store.data.obs.find(i=>i.name===k); if(o&&Math.hypot(o.lon-lon,o.lat-lat)<r) { Ui.showInfo(o,'obs'); h=true; } });
             if(!h&&Store.layers.players) {
                 Store.data.players.forEach(g=>{ 
                    const locs = g.locations || g.spawnPoints || g.spawns || [];
                    const p=locs.find(pt=>{
                        const lat = safeCoord(pt.lat !== undefined ? pt.lat : pt.latitude);
                        const lon = safeCoord(pt.lon !== undefined ? pt.lon : pt.longitude);
                        return Math.hypot(lon-lon, lat-lat) < r;
                    }); 
                    if(p) { Ui.showInfo({name:"Spieler Spawn",lat:p.lat,lon:p.lon,description:g.name||"Spawn Zone"},'player'); h=true; } 
                 });
             }
        }
    }
};

window.Ui = {
    // MEGA WIDGET LOGIC: DYNAMIC MENU GENERATION
    init(cfg) {
        const list = document.getElementById('map-list-container');
        if(!list) return;
        
        const keys = Object.keys(cfg).filter(k => cfg[k].activated);
        keys.sort((a,b) => cfg[a].displayName.localeCompare(cfg[b].displayName));
        
        list.innerHTML = keys.map(k => `
            <button class="map-btn" onclick="Ui.switchMap(this, '${k}')">
                <span>‚Ä¢ ${cfg[k].displayName}</span>
                <span class="status-dot"></span>
            </button>
        `).join('');
    },
    switchMap(btn, key) {
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Data.loadMap(key);
    },
    toggleToolSidebar() {
        const sb = document.getElementById('tool-sidebar');
        const t = document.getElementById('tool-toggle');
        const c = sb.classList.toggle('collapsed');
        t.innerHTML = c ? '‚ñ∂' : '‚óÄ';
        setTimeout(()=>MapEngine.fit(), 310);
    },
    
    // --- EXPLORER CORE ---
    tab(id) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); const idx=['dinos','res','pois'].indexOf(id); if(idx!==-1) document.querySelectorAll('.tab-btn')[idx].classList.add('active'); document.getElementById('view-'+id).classList.add('active'); setTimeout(()=>MapEngine.fit(), 10); },
    toggleLiveMode() { Store.liveMode=!Store.liveMode; const b=document.getElementById('live-map-btn'), f=document.getElementById('live-map-frame'), body=document.body; if(Store.liveMode) { b.classList.add('live-active'); body.classList.add('live-mode-active'); f.classList.remove('hidden'); const u=Store.map.liveMapDataUrl||Store.map.LiveMapDataUrl||Store.map.iframeUrl; if(u) f.src=u; } else { b.classList.remove('live-active'); body.classList.remove('live-mode-active'); f.classList.add('hidden'); f.src=""; } },
    renderDinos(term="") { const l=document.getElementById('dino-list-root'); if(!l) return; const t=term.toLowerCase(), keys=Object.keys(Store.data.dinos).sort(), show=keys.filter(k=>(Store.trans.dinos[k]||k).toLowerCase().includes(t)); l.innerHTML=show.map(k=>`<div class="select-item ${Store.selDino===k?'selected':''}" onclick="Ui.selDino('${k}','${Store.trans.dinos[k]||k}')"><img src="${fixUrl(Store.icons[k]?.iconUrl||'')}"><span>${Store.trans.dinos[k]||k}</span></div>`).join(''); },
    toggleDinoDropdown() { const d=document.getElementById('dino-dropdown-content'); d.classList.toggle('open'); document.querySelector('.select-trigger').classList.toggle('active'); if(d.classList.contains('open')) document.getElementById('search-dino').focus(); },
    selDino(k,n) { Store.selDino=k; document.getElementById('dino-trigger-text').textContent=n; document.getElementById('dino-clear-btn').classList.remove('hidden'); this.toggleDinoDropdown(); MapEngine.draw(); },
    clearDino() { Store.selDino=null; document.getElementById('dino-trigger-text').textContent="W√§hle Dino..."; document.getElementById('dino-clear-btn').classList.add('hidden'); MapEngine.draw(); },
    resetDinoSelectionUI() { this.clearDino(); },
    renderRes() { const l=document.getElementById('list-res'); if(!l) return; l.innerHTML=Object.keys(Store.data.res).sort().map(k=>`<div class="toggle-item" onclick="Ui.togRes('${k}',this)"><div class="chk"></div>${Store.icons[k]?.iconUrl?`<img src="${fixUrl(Store.icons[k].iconUrl)}" style="width:20px;height:20px;margin-right:8px;object-fit:contain">`:''}<span class="text-xs text-gray-300">${Store.trans.res[k]||k}</span></div>`).join(''); },
    togRes(k,el) { if(Store.activeRes.has(k)) { Store.activeRes.delete(k); el.classList.remove('checked'); } else { Store.activeRes.add(k); el.classList.add('checked'); } MapEngine.draw(); },
    renderObs() { const l=document.getElementById('list-obelisks'); if(!l) return; l.innerHTML=Store.data.obs.map(o=>`<div class="toggle-item" onclick="Ui.togObs('${o.name}',this)"><div class="chk"></div><span class="text-xs text-gray-300">${o.name}</span></div>`).join(''); },
    togObs(k,el) { if(Store.activeObs.has(k)) { Store.activeObs.delete(k); el.classList.remove('checked'); } else { Store.activeObs.add(k); el.classList.add('checked'); } MapEngine.draw(); },
    renderRegions() {
        const l=document.getElementById('list-regions'), c=document.getElementById('region-container'); if(!l||!c) return;
        let regs = Store.data.regions; if(regs&&regs.regions&&Array.isArray(regs.regions)) regs=regs.regions; if(!Array.isArray(regs)) regs=[]; Store.data.regions=regs;
        if(regs.length===0) { c.classList.add('hidden'); return; } c.classList.remove('hidden');
        l.innerHTML=regs.map(r=>`<div class="toggle-item" onclick="Ui.togRegion('${r.id}',this)"><div class="chk"></div><span class="text-xs text-gray-300">${r.name}</span></div>`).join('');
    },
    togRegion(id,el) { if(Store.activeRegions.has(id)) { Store.activeRegions.delete(id); el.classList.remove('checked'); } else { Store.activeRegions.add(id); el.classList.add('checked'); } MapEngine.draw(); },
    showInfo(d,type) { Store.selectedPOI=d; MapEngine.setMarker(d); document.getElementById('info-title').textContent=d.name||"Info"; let m='', e=''; if(d.images?.length) m=`<div class="relative group cursor-pointer" onclick="Ui.openDetail()"><img src="${fixUrl(d.images[0])}" class="w-full rounded mb-4 border border-gray-700"><div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><span class="img-overlay-btn">üîç VERGR√ñSSERN</span></div></div>`; else if(d.icon) m=`<img src="${fixUrl(d.icon)}" class="w-20 mx-auto mb-4">`; if(type==='caves'&&d.artifacts) e=`<div class="text-xs font-bold text-amber-500 mt-4 mb-2 tracking-wider">ARTEFAKTE</div>`+d.artifacts.map(a=>`<div class="artifact-row"><img src="${fixUrl(a.icon||Store.icons[a.name]?.iconUrl)}" class="artifact-icon"><span>${a.name}</span></div>`).join(''); if(type==='public'||type==='caves') { const lst=type==='public'?Store.data.pois:Store.data.caves; e+=`<div class="text-xs font-bold text-gray-500 mt-6 mb-2 tracking-wider">ANDERE</div><div class="flex flex-col gap-1 related-list">${lst.map((it,i)=>`<div class="related-item ${it===d?'active':''}" onclick="Ui.selectFromList('${type}',${i})">${it.name}</div>`).join('')}</div>`; } document.getElementById('info-body').innerHTML=`${m}<div class="flex justify-center gap-4 mb-4 text-xs font-mono text-gray-500 bg-black p-2 rounded border border-[#333]"><span>LAT: <span class="text-orange-500 font-bold">${d.lat.toFixed(1)}</span></span><span>LON: <span class="text-orange-500 font-bold">${d.lon.toFixed(1)}</span></span></div><div class="text-sm text-gray-400 whitespace-pre-wrap">${d.description||d.shortDescription||''}</div>${e}`; document.getElementById('info-panel').classList.add('visible'); },
    selectFromList(t,i) { const l=t==='public'?Store.data.pois:Store.data.caves; if(l[i]) this.showInfo(l[i],t); },
    closeInfo() { document.getElementById('info-panel').classList.remove('visible'); MapEngine.setMarker(null); },
    showMapInfo() { const i=Store.data.mapInfo; if(!i) return; let c=i.generalInfo?`<div class="text-gray-300 mb-6 text-sm leading-relaxed">${i.generalInfo}</div>`:''; if(i.infoBadges) { c+=`<div class="info-grid">`; Object.entries(i.infoBadges).forEach(([k,v])=>{ c+=`<div class="info-card"><h4>${k}</h4><div>${Array.isArray(v)?v.map(t=>`<span class="info-tag">${t}</span>`).join(''):`<span class="text-gray-400 text-sm">${v}</span>`}</div></div>`; }); c+=`</div>`; } if(i.specialInfo) { c+=`<div class="mt-8 border-t border-gray-800 pt-4"><h3 class="text-phoenix-gold font-bold uppercase mb-3 text-sm tracking-widest">${i.specialInfo.Kategorie||'Special Info'}</h3><div class="flex flex-wrap gap-2 mb-3">${(i.specialInfo.Liste||[]).map(l=>`<span class="bg-blue-900/40 text-blue-200 px-2 py-1 rounded text-xs border border-blue-900">${l}</span>`).join('')}</div>${i.specialInfo.OnEachMap_Liste?`<div class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide mt-4">Auf jeder Karte:</div><div class="flex flex-wrap gap-2">${i.specialInfo.OnEachMap_Liste.map(l=>`<span class="bg-cyan-900/40 text-cyan-200 px-2 py-1 rounded text-xs border border-cyan-900">${l}</span>`).join('')}</div>`:''}</div>`; } document.getElementById('map-info-content').innerHTML=c; document.getElementById('map-info-modal').classList.add('visible'); },
    closeMapInfo() { document.getElementById('map-info-modal').classList.remove('visible'); },
    openDetail() { Store.currentImgIdx=0; this.updateDetail(); document.getElementById('detail-modal').classList.add('visible'); },
    updateDetail() { const d=Store.selectedPOI, imgs=d.images||(d.icon?[d.icon]:[]), s=imgs[Store.currentImgIdx]; document.getElementById('detail-title').textContent=d.name; document.getElementById('detail-img').src=fixUrl(s); document.getElementById('detail-lat').textContent=d.lat.toFixed(1); document.getElementById('detail-lon').textContent=d.lon.toFixed(1); document.getElementById('detail-desc').textContent=d.longDescription||d.description; document.getElementById('gal-count').style.display=imgs.length>1?'block':'none'; if(imgs.length>1) document.getElementById('gal-count').textContent=`${Store.currentImgIdx+1}/${imgs.length}`; document.getElementById('gal-prev').style.display=imgs.length>1?'flex':'none'; document.getElementById('gal-next').style.display=imgs.length>1?'flex':'none'; let a=''; if(d.artifacts) a=`<div class="mt-6 border-t border-gray-700 pt-4"><h3 class="text-amber-500 font-bold mb-2">ARTEFAKTE</h3><div class="grid grid-cols-2 gap-2">`+d.artifacts.map(x=>`<div class="modal-artifact-row">${x.name}</div>`).join('')+`</div></div>`; document.getElementById('detail-artifacts').innerHTML=a; },
    nextImg() { const d=Store.selectedPOI, l=d.images?.length||0; if(l<2) return; Store.currentImgIdx=(Store.currentImgIdx+1)%l; this.updateDetail(); },
    prevImg() { const d=Store.selectedPOI, l=d.images?.length||0; if(l<2) return; Store.currentImgIdx=(Store.currentImgIdx-1+l)%l; this.updateDetail(); },
    closeDetail() { document.getElementById('detail-modal').classList.remove('visible'); },
    setSpawnStatus(t,m) { const x=document.getElementById('spawn-msg'); if(x) x.textContent=m; },
    resetToggles() { Store.layers = {public:false,caves:false,players:false}; document.querySelectorAll('.toggle-item').forEach(e=>e.classList.remove('checked')); },
};

window.Obs = { toggleAll() { const k=Store.data.obs.map(o=>o.name); if(!k.length) return; const on=Store.activeObs.size!==k.length; if(on) k.forEach(x=>Store.activeObs.add(x)); else Store.activeObs.clear(); document.querySelectorAll('#list-obelisks .toggle-item').forEach(e=>on?e.classList.add('checked'):e.classList.remove('checked')); document.getElementById('tog-all-obs').classList.toggle('checked',on); MapEngine.draw(); } };
window.Reg = { toggleAll() { const k=Store.data.regions.map(r=>r.id); if(!k.length) return; const on=Store.activeRegions.size!==k.length; if(on) k.forEach(x=>Store.activeRegions.add(x)); else Store.activeRegions.clear(); document.querySelectorAll('#list-regions .toggle-item').forEach(e=>on?e.classList.add('checked'):e.classList.remove('checked')); document.getElementById('tog-all-regions').classList.toggle('checked',on); MapEngine.draw(); } };

const Data = {
    async init() {
        try { const [c,i,t,s,b,a] = await Promise.all([fetchJson(CFG.urlC),fetchJson(CFG.urlI),fetchJson(CFG.urlT),fetchJson(CFG.urlShare),fetchJson(CFG.urlBlock),fetchJson(CFG.urlAlpha)]); 
        Store.cfg=c; 
        // FIX: Flatten all icon categories
        Store.icons = {};
        if(i) {
             Object.values(i).forEach(cat => {
                 if(typeof cat === 'object') Object.assign(Store.icons, cat);
             });
        }
        
        if(t){Store.trans.dinos=t.Kreaturen||{};Store.trans.res=t.Ressourcen||{};} Store.sharing=s; Store.blocked=b; Store.alphas=a;
        Ui.init(c); Data.loadMap('TheIsland'); } catch(e){console.error(e);}
    },
    async loadMap(k) {
        try {
            const c=Store.cfg[k]; Store.map=c; Store.mapKey=k; Store.selDino=null; Store.activeRes.clear(); Store.activeObs.clear(); Store.activeRegions.clear(); Ui.resetDinoSelectionUI(); MapEngine.reset(); MapEngine.load(c.mapImageUrl);
            const live=c.liveMapDataUrl||c.LiveMapDataUrl||c.iframeUrl; if(live) Store.map.liveMapDataUrl=live;
            const regUrl=c.regionDataUrl||c.RegionDataUrl||c.regionsDataUrl||c.RegionsDataUrl; const infoUrl=c.infoBadgeUrl||c.InfoBadgeUrl;
            const res = await Promise.all([
                fetchJson(c.creatureDataUrl), fetchJson(c.resourceDataUrl), fetchJson(c.publicSpotsDataUrl),
                fetchJson(c.obeliskDataUrl), fetchJson(c.caveSpotsDataUrl), fetchJson(c.playerSpawnDataUrl),
                c.alphaDataUrl?fetchJson(c.alphaDataUrl):null, regUrl?fetchJson(regUrl):null, infoUrl?fetchJson(infoUrl):null
            ]);
            const [d,r,p,o,ca,pl,al,regData,infoData] = res;
            let regionsList=[]; if(regData) { if(Array.isArray(regData)) regionsList=regData; else if(regData.regions&&Array.isArray(regData.regions)) regionsList=regData.regions; }
            Store.data = { dinos:d?.dinoSpawns||{}, res:r?.resources||{}, pois:p?.publicSpots||[], obs:o?.obelisks||[], caves:ca?.caveSpots||[], players:findSpawns(pl), regions:regionsList, mapInfo:infoData };
            
            const infoBtn=document.getElementById('map-info-btn'); if(infoBtn) infoBtn.classList.toggle('hidden',!infoData);
            const liveBtn=document.getElementById('live-map-btn'); if(liveBtn) liveBtn.classList.toggle('hidden',!live);
            
            const frame = document.getElementById('live-map-frame');
            if(Store.liveMode) { if(live) { frame.src=live; frame.classList.remove('hidden'); document.body.classList.add('live-mode-active'); } else { Store.liveMode=false; document.getElementById('live-map-btn').classList.remove('live-active'); document.body.classList.remove('live-mode-active'); frame.classList.add('hidden'); frame.src=""; } }

            if(c.alphaVariantKey&&Store.alphas[c.alphaVariantKey]) { const v=Store.alphas[c.alphaVariantKey]; Object.keys(v).forEach(n=>{ if(Store.data.dinos[n]) { Store.data.dinos[v[n]]=Store.data.dinos[n]; if(!Store.trans.dinos[v[n]]) Store.trans.dinos[v[n]]=v[n]; } }); }
            if(Store.sharing) { Object.keys(Store.sharing).forEach(s=>{ const t=Store.sharing[s]; if(Array.isArray(t)&&Store.data.dinos[s]) t.forEach(tn=>{ if(!Store.data.dinos[tn]) { Store.data.dinos[tn]=Store.data.dinos[s]; if(!Store.trans.dinos[tn]) Store.trans.dinos[tn]=tn; } }); }); }
            
            document.getElementById('tog-players').classList.toggle('disabled', !Store.data.players.length);
            Ui.renderDinos(); Ui.renderRes(); Ui.renderObs(); Ui.renderRegions(); if(typeof Ui.resetToggles==='function') Ui.resetToggles(); MapEngine.draw();
        } catch(e){console.error(e);}
    }
};

document.getElementById('search-dino').oninput = e => Ui.renderDinos(e.target.value);
document.addEventListener("DOMContentLoaded", () => { MapEngine.init(); Data.init(); });

</script>
</body>
</html>
