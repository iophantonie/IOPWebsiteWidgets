<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IOP Cluster Explorer v32.0 (Live & Cave Fix)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- CORE RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000000; overflow: hidden; font-family: 'Segoe UI', 'Roboto', sans-serif; color: #e2e8f0; }

        :root {
            --phoenix-fire: #ff2a00;
            --phoenix-gold: #fbbf24;
            --bg-panel: #0a0a0a;
            --sidebar-width: 320px;
        }

        #app { position: absolute; inset: 0; display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width); height: 100%; 
            background: var(--bg-panel); border-right: 1px solid #333;
            display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
            transition: margin-left 0.3s ease; 
        }
        
        #sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        
        /* Disable Sidebar content in Live Mode */
        .live-mode-active .sb-content { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .live-mode-active .tabs { opacity: 0.3; pointer-events: none; }

        .sb-header { padding: 15px; background: #000; border-bottom: 2px solid var(--phoenix-fire); }
        .sb-title { font-size: 1.0rem; font-weight: 900; color: var(--phoenix-fire); letter-spacing: 0.05em; }
        
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 10px; color: #777; font-size: 0.75rem; font-weight: 700; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn:hover { color: white; background: #1a1a1a; }
        .tab-btn.active { color: var(--phoenix-fire); border-color: var(--phoenix-fire); background: linear-gradient(to top, rgba(255, 42, 0, 0.1), transparent); }

        .sb-content { flex: 1; overflow-y: auto; position: relative; padding: 15px; scrollbar-width: thin; scrollbar-color: #333 #0a0a0a; transition: opacity 0.3s; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- TOGGLE BUTTONS --- */
        #sidebar-toggle {
            position: relative; 
            width: 24px; height: 48px; background: #111; border: 1px solid #444; border-left: none;
            border-radius: 0 6px 6px 0; cursor: pointer; z-index: 60; margin-top: auto; margin-bottom: auto;
            display: flex; align-items: center; justify-content: center; color: #888;
            align-self: center; 
            transition: color 0.2s;
        }
        #sidebar-toggle:hover { color: var(--phoenix-fire); }

        /* --- MOBILE TOGGLE --- */
        #mobile-toggle {
            position: absolute; top: 15px; left: 15px; z-index: 60;
            width: 40px; height: 40px; background: rgba(0,0,0,0.8); border-radius: 4px; border: 1px solid #444;
            display: none; align-items: center; justify-content: center; color: var(--phoenix-fire); font-size: 20px; cursor: pointer;
        }
        @media (max-width: 768px) { #mobile-toggle { display: flex; } #sidebar-toggle { display: none; } }

        /* --- MAP ENGINE --- */
        #viewport { flex: 1; position: relative; background: #050505; overflow: hidden; display: block; }
        
        #world {
            position: absolute; top: 0; left: 0; width: 1024px; height: 1024px;
            box-shadow: 0 0 100px rgba(0,0,0,0.5); transform-origin: 0 0;
            will-change: transform;
        }
        /* Hidden in Live Mode */
        .live-mode-active #world, 
        .live-mode-active .map-legend,
        .live-mode-active .hud-bot,
        .live-mode-active #coords-display { display: none !important; }

        #map-image-layer { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: fill; pointer-events: none; }
        #data-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        #input-layer { position: absolute; inset: 0; width: 100%; height: 100%; cursor: grab; z-index: 10; }
        #input-layer:active { cursor: grabbing; }

        /* LIVE MAP IFRAME FIX */
        #live-map-frame { position: absolute; inset: 0; width: 100%; height: 100%; border: none; z-index: 100; background: #000; }
        
        /* --- MARKER & PULSE --- */
        .pulse-marker {
            position: absolute; width: 60px; height: 60px; border: 2px solid var(--phoenix-fire); border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--phoenix-fire), inset 0 0 10px var(--phoenix-fire);
            z-index: 5; pointer-events: none; animation: pulse 2s infinite; display: none;
        }
        @keyframes pulse { 0% {transform:translate(-50%,-50%) scale(0.5);opacity:1} 100% {transform:translate(-50%,-50%) scale(1.5);opacity:0} }

        /* --- UI COMPONENTS --- */
        .toggle-item { display: flex; align-items: center; padding: 6px 0; cursor: pointer; user-select: none; }
        .chk { width: 16px; height: 16px; border: 2px solid #444; border-radius: 3px; margin-right: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: #000; }
        .toggle-item.checked .chk { background: var(--phoenix-fire); border-color: var(--phoenix-fire); }
        .toggle-item.checked .chk::after { content: '‚úì'; color: black; font-weight: bold; font-size: 10px; }
        .toggle-item.disabled { opacity: 0.5; pointer-events: none; }

        .select-item { display: flex; align-items: center; padding: 8px; cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        .select-item:hover { background: #1a1a1a; }
        .select-item.selected { background: rgba(255,42,0,0.1); border-left: 3px solid var(--phoenix-fire); }
        .select-item img { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }

        .custom-select { position: relative; }
        .select-trigger { background: #151515; border: 1px solid #444; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .select-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: #111; border: 1px solid #444; max-height: 300px; overflow-y: auto; z-index: 100; display: none; }
        .select-dropdown.open { display: block; }
        .select-search { position: sticky; top: 0; background: #111; padding: 8px; border-bottom: 1px solid #333; z-index: 10; }
        .select-search input { width: 100%; background: #222; border: 1px solid #444; padding: 6px; border-radius: 4px; color: white; font-size: 0.85rem; outline: none; }

        /* ARTIFACTS */
        .artifact-row { display: flex; align-items: center; margin-bottom: 5px; background: rgba(251,191,36,0.1); padding: 8px; border: 1px solid var(--phoenix-gold); border-radius: 4px; color: var(--phoenix-gold); font-weight: bold; font-size: 0.85rem; animation: glow 2s infinite alternate; }
        .artifact-icon { width: 36px; height: 36px; margin-right: 10px; object-fit: contain; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(251,191,36,0.2); } to { box-shadow: 0 0 15px rgba(251,191,36,0.6); } }

        /* LEGEND */
        .map-legend { position: absolute; bottom: 20px; left: 20px; width: 160px; background: rgba(10,10,10,0.9); border: 1px solid #333; border-left: 3px solid var(--phoenix-fire); padding: 10px; z-index: 50; font-size: 10px; color: #ccc; pointer-events: none; }
        .leg-item { display: flex; align-items: center; margin-bottom: 2px; }
        .leg-box { width: 10px; height: 10px; margin-right: 8px; }

        /* INFO PANEL */
        .info-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 320px; background: var(--bg-panel); border-left: 1px solid var(--phoenix-fire); transform: translateX(100%); transition: transform 0.3s; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.9); display: flex; flex-direction: column; }
        .info-panel.visible { transform: translateX(0); }
        .info-header { padding: 15px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .info-title { font-size: 1.0rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.05em; }
        .info-close { color: #888; cursor: pointer; font-size: 1.5rem; transition: 0.2s; line-height: 1; }
        .info-close:hover { color: var(--phoenix-fire); }

        /* RELATED LIST */
        .related-list { margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; display: flex; flex-direction: column; gap: 4px; }
        .related-item { padding: 8px 10px; cursor: pointer; border-radius: 4px; font-size: 0.85rem; color: #ccc; border: 1px solid #222; border-left: 3px solid transparent; background: #161616; transition: all 0.2s; }
        .related-item:hover { background: #222; color: white; border-left-color: #666; transform: translateX(2px); }
        .related-item.active { background: rgba(255, 42, 0, 0.1); border-left-color: var(--phoenix-fire); color: var(--phoenix-fire); font-weight: bold; border-color: rgba(255, 42, 0, 0.2); }

        /* DETAIL MODAL */
        .modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-card { background: #0a0a0a; border: 1px solid #333; border-left: 3px solid var(--phoenix-fire); width: 90%; max-width: 900px; height: 90%; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; overflow: hidden; position: relative; }
        .modal-img-container { width: 100%; height: 50%; background: #000; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #333; position: relative; flex-shrink: 0; }
        .modal-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-body { padding: 25px; flex: 1; overflow-y: auto; min-height: 0; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; font-size: 20px; transition: 0.2s; z-index: 60; }
        .modal-close:hover { border-color: var(--phoenix-fire); color: var(--phoenix-fire); }
        .modal-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; transition: 0.2s; border: 1px solid transparent; z-index: 50; }
        .modal-nav-btn:hover { background: rgba(0,0,0,0.9); border-color: var(--phoenix-fire); color: var(--phoenix-fire); }
        .nav-prev { left: 20px; } .nav-next { right: 20px; }
        .img-counter { position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.7); color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: monospace; }
        .img-overlay-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: var(--phoenix-gold); padding: 5px 10px; border-radius: 4px; border: 1px solid var(--phoenix-gold); font-size: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .img-overlay-btn:hover { background: var(--phoenix-gold); color: black; }
        .modal-artifact-row { display: inline-block; margin: 5px; background: rgba(251,191,36,0.1); padding: 6px 12px; border: 1px solid var(--phoenix-gold); border-radius: 4px; color: var(--phoenix-gold); font-weight: bold; font-size: 0.9rem; }

        /* MAP INFO STYLES */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .info-card { background: #161616; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        .info-card h4 { color: var(--phoenix-gold); font-size: 0.8rem; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .info-tag { display: inline-block; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin: 2px; color: #ccc; }
        
        .loader { position: absolute; inset: 0; background: #000; z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; backdrop-filter: blur(5px); }
        .loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top-color: var(--phoenix-fire); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); border: 1px solid var(--phoenix-fire); color: white; padding: 15px 25px; border-radius: 8px; z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        #toast.visible { opacity: 1; }
        
        /* LIVE BUTTON STYLES */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .btn-live { border-color: #ef4444; color: #ef4444; animation: pulse-red 2s infinite; }
        .btn-live:hover { background: #ef4444; color: white; }
        .live-active { background: #ef4444 !important; color: white !important; animation: none !important; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .hidden { display: none !important; }
        .phoenix-input { w-full: 100%; background: #050505; border: 1px solid #333; padding: 8px; border-radius: 6px; color: white; outline: none; font-size: 0.9rem; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.ok { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-dot.err { background: #ef4444; }
        .status-dot.wait { background: #f59e0b; }
        
        .hud-bot { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 8px; z-index: 50; }
        .zoom-btn { width: 40px; height: 40px; background: #111; border: 1px solid #444; color: white; border-radius: 6px; font-size: 20px; cursor: pointer; display: grid; place-items: center; }
        .zoom-btn:hover { border-color: var(--phoenix-fire); color: var(--phoenix-fire); }
        
        #error-log { position: absolute; top: 0; left: 0; width: 100%; background: rgba(220, 38, 38, 0.95); color: white; padding: 5px; font-size: 11px; z-index: 10000; display: none; text-align: center; }
    </style>
</head>
<body>

<div id="error-log"></div>
<div id="toast">Nachricht</div>

<div id="loader" class="loader">
    <div class="spinner mb-4"></div>
    <div id="loader-msg" class="text-white font-bold text-sm tracking-widest uppercase" style="color: var(--phoenix-fire)">Lade System...</div>
</div>

<div id="app">
    <div id="mobile-toggle" onclick="Ui.toggleSidebar()">‚ò∞</div>
    <div id="sidebar">
        <div class="sb-header">
            <div class="flex items-center justify-between mb-1">
                <div><div class="text-xs text-gray-500 font-bold tracking-widest mb-1">INFINITY OF PHOENIX</div><div class="sb-title">CLUSTER EXPLORER</div></div>
                <div class="flex items-center gap-2">
                    <button id="live-map-btn" onclick="Ui.toggleLiveMode()" class="hidden px-2 py-1 rounded border border-gray-600 bg-gray-900 text-xs font-bold tracking-wider btn-live">LIVE</button>
                    <button id="map-info-btn" onclick="Ui.showMapInfo()" class="hidden px-2 py-1 rounded border border-gray-600 bg-gray-800 text-xs text-gray-300 hover:border-phoenix-fire hover:text-phoenix-fire transition-colors uppercase font-bold tracking-wider">MAP INFO</button>
                    <img src="https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/IOPCOM_Logo.png" class="w-10 h-10 object-contain" alt="Logo">
                </div>
            </div>
            <select id="map-select" class="phoenix-input mt-3 text-sm"><option>Lade Karten...</option></select>
        </div>

        <nav class="tabs">
            <button class="tab-btn active" onclick="Ui.tab('dinos')">DINOS</button>
            <button class="tab-btn" onclick="Ui.tab('res')">RES.</button>
            <button class="tab-btn" onclick="Ui.tab('pois')">ORTE</button>
        </nav>

        <div class="sb-content">
            <div id="view-dinos" class="view active">
                <div class="text-xs font-bold text-gray-500 mb-2 tracking-wider">KREATUREN</div>
                <div class="custom-select" id="dino-dropdown">
                    <div class="select-trigger" onclick="Ui.toggleDinoDropdown()">
                        <span id="dino-trigger-text" class="truncate">W√§hle Dino...</span>
                        <div class="flex items-center"><span id="dino-clear-btn" class="text-xs text-gray-500 hover:text-white mr-2 hidden px-2 cursor-pointer" onclick="event.stopPropagation(); Ui.clearDino()">‚úï</span><span class="text-xs text-gray-500">‚ñº</span></div>
                    </div>
                    <div id="dino-dropdown-content" class="select-dropdown">
                        <div class="p-2 bg-[#111] sticky top-0 border-b border-gray-700"><input type="text" id="search-dino" placeholder="Suche..." class="phoenix-input" autocomplete="off"></div>
                        <div id="dino-list-root"></div>
                    </div>
                </div>
            </div>

            <div id="view-res" class="view">
                <div class="mb-4 border-b border-gray-800 pb-2">
                    <div class="toggle-item" id="tog-all-res" onclick="Res.toggleAll()"><div class="chk"></div><span class="text-xs font-bold text-gray-500 tracking-wider">ALLE RESSOURCEN</span></div>
                </div>
                <div id="list-res"></div>
            </div>

            <div id="view-pois" class="view">
                <div class="mb-6">
                    <div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">ALLGEMEIN</div>
                    <div class="toggle-item mb-2" id="tog-all-pois" onclick="Layers.toggleAllPois()"><div class="chk"></div><span class="text-amber-500 text-sm font-bold">Alle Orte einblenden</span></div>
                    
                    <!-- DYNAMIC REGIONS -->
                    <div id="region-container" class="hidden mb-2 pl-4 border-l-2 border-[#1a1a1a] ml-1">
                        <div class="text-[10px] text-gray-600 font-bold mb-1 mt-2 uppercase tracking-wider">Regionen</div>
                        <div class="toggle-item mb-2" id="tog-all-regions" onclick="Reg.toggleAll()"><div class="chk"></div><span class="text-xs font-bold text-gray-400">Alle Regionen</span></div>
                        <div id="list-regions"></div>
                    </div>

                    <div class="pl-4 border-l-2 border-[#1a1a1a] ml-1 mt-2">
                        <div class="toggle-item" id="tog-public" onclick="Layers.toggle('public')"><div class="chk"></div><span>Public Spots</span></div>
                        <div class="toggle-item" id="tog-caves" onclick="Layers.toggle('caves')"><div class="chk"></div><span>H√∂hlen</span></div>
                    </div>
                </div>
                <div class="mb-6">
                    <div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">SPAWNS</div>
                    <div class="toggle-item" id="tog-players" onclick="Layers.toggle('players')"><div class="chk"></div><span>Spieler Spawns</span></div>
                    <div class="text-xs text-gray-600 ml-8 mt-1 italic flex items-center"><span id="spawn-msg"></span></div>
                </div>
                <div><div class="text-xs text-gray-500 font-bold mb-2 tracking-wider">OBELISKEN</div><div class="toggle-item mb-2" id="tog-all-obs" onclick="Obs.toggleAll()"><div class="chk"></div><span class="text-xs font-bold text-gray-400">Alle Obelisken</span></div><div id="list-obelisks"></div></div>
            </div>
        </div>
    </div>

    <div id="sidebar-toggle" onclick="Ui.toggleSidebar()">‚óÄ</div>

    <div id="viewport">
        <!-- LIVE MAP IFRAME -->
        <iframe id="live-map-frame" class="absolute inset-0 w-full h-full hidden z-20 bg-black" frameborder="0"></iframe>

        <div class="map-legend">
            <div class="font-bold text-amber-500 mb-2 uppercase text-[10px]">Spawn Raten</div>
            <div class="leg-item"><div class="leg-box" style="background:#22c55e"></div>Sehr H√§ufig</div>
            <div class="leg-item"><div class="leg-box" style="background:#84cc16"></div>H√§ufig</div>
            <div class="leg-item"><div class="leg-box" style="background:#eab308"></div>Gelegentlich</div>
            <div class="leg-item"><div class="leg-box" style="background:#f97316"></div>Selten</div>
            <div class="leg-item"><div class="leg-box" style="background:#ef4444"></div>Sehr Selten</div>
            <div class="leg-item"><div class="leg-box" style="background:#a855f7"></div>Extrem Selten</div>
            <div class="leg-item mt-2"><div class="leg-box" style="background:repeating-linear-gradient(45deg,#fff2,#fff2 2px,transparent 2px,transparent 4px);border:1px solid #777"></div>H√∂hle</div>
        </div>

        <div id="world">
            <img id="map-image-layer" src="" alt="Karte">
            <canvas id="data-canvas"></canvas>
            <div id="selection-marker" class="pulse-marker"></div>
            <div id="input-layer"></div>
        </div>
        
        <div class="absolute top-5 right-5 bg-black/90 px-4 py-2 rounded font-mono text-sm border border-gray-800 pointer-events-none z-50" style="color: var(--phoenix-gold);">
            LAT: <span id="lat">00.0</span> | LON: <span id="lon">00.0</span>
        </div>
        
        <div class="hud-bot">
            <button class="zoom-btn" onclick="Ui.toggleFullscreen()">‚õ∂</button>
            <button class="zoom-btn" onclick="MapEngine.reset()">‚ü≤</button>
        </div>
    </div>

    <div id="info-panel" class="info-panel">
        <div class="info-header">
            <h2 id="info-title" class="text-lg font-bold text-white uppercase truncate">Info</h2>
            <button onclick="Ui.closeInfo()" class="text-gray-400 hover:text-white text-2xl leading-none">√ó</button>
        </div>
        <div id="info-body" class="p-5 text-sm text-gray-300 overflow-y-auto h-full"></div>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="modal-overlay" onclick="if(event.target===this) Ui.closeDetail()">
        <div class="modal-card">
            <button class="modal-close" onclick="Ui.closeDetail()">√ó</button>
            <div class="modal-img-container">
                <img id="detail-img" class="modal-img" alt="">
                <div id="gal-prev" class="modal-nav-btn nav-prev" onclick="Ui.prevImg()">‚ùÆ</div>
                <div id="gal-next" class="modal-nav-btn nav-next" onclick="Ui.nextImg()">‚ùØ</div>
                <div id="gal-count" class="img-counter">1 / 1</div>
            </div>
            <div class="modal-body">
                <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-4">
                    <h2 id="detail-title" class="text-2xl font-black text-white uppercase tracking-wide">Titel</h2>
                    <div class="text-right">
                         <div class="text-xs text-gray-500 font-bold mb-1">KOORDINATEN</div>
                         <div class="text-phoenix-gold font-mono font-bold text-lg"><span id="detail-lat">00.0</span> / <span id="detail-lon">00.0</span></div>
                    </div>
                </div>
                <div id="detail-desc" class="text-gray-300 leading-relaxed mb-6 whitespace-pre-wrap"></div>
                <div id="detail-artifacts"></div>
            </div>
        </div>
    </div>

    <!-- MAP INFO MODAL -->
    <div id="map-info-modal" class="modal-overlay" onclick="if(event.target===this) Ui.closeMapInfo()">
        <div class="modal-card" style="max-width: 800px; height: auto; max-height: 90%;">
            <button class="modal-close" onclick="Ui.closeMapInfo()">√ó</button>
            <div class="p-6 bg-[#0a0a0a] overflow-y-auto">
                <h2 class="text-2xl font-black text-white uppercase mb-4 border-b border-gray-800 pb-2">Karten Informationen</h2>
                <div id="map-info-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
// CONFIG
const CFG = {
    urlC: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/MapConfigs/MapConfigs.jsn',
    urlI: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/refs/heads/main/Icon_Datenbank/Icondb.jsn',
    urlT: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Translation_Datenbank/translationdb.jsn',
    urlShare: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/SpawnSharingConfig/spawnsharing.jsn',
    urlBlock: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Blocked_Zones_Datenbank/blockedzonesdb.jsn',
    urlAlpha: 'https://raw.githubusercontent.com/iophantonie/iophantonie-IOP_Custom_Map_Explorer.github.io/main/Alpha_Listen_Datenbank/alphalistdb.jsn',
    col: { spawn: 'rgba(255, 42, 0, 0.4)', stroke: '#ff2a00' },
    rarity: [{th:0.10,c:'#22c55e'},{th:0.05,c:'#84cc16'},{th:0.02,c:'#eab308'},{th:0.01,c:'#f97316'},{th:0.001,c:'#ef4444'},{th:0,c:'#a855f7'}]
};

function fixUrl(url) {
    if (!url) return '';
    if (url.includes('github.com') && url.includes('/blob/')) return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    return url; 
}
function hexToRgba(hex, alpha) {
    const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${alpha})`;
}
async function fetchJson(url) {
    try {
        const r = await fetch(fixUrl(url));
        if(!r.ok) throw new Error("HTTP "+r.status);
        const t = await r.text();
        return JSON.parse(t.replace(/^\uFEFF/,'').replace(/\u00A0/g,' '));
    } catch(e) { console.warn("Fetch Error", e); return null; }
}
function findSpawns(data) {
    if(!data) return [];
    if(data.spawnPoints && Array.isArray(data.spawnPoints)) return data.spawnPoints;
    let found = [];
    const search = o => {
        if(!o || typeof o!=='object') return;
        if(Array.isArray(o)) {
            if(o.length>0 && (o[0].locations||o[0].lat!==undefined)) { found=o; return; }
            o.forEach(search);
        } else {
            if(o.spawnPoints) { found=o.spawnPoints; return; }
            Object.values(o).forEach(search);
        }
    }
    search(data);
    return found.length>0 ? found : (Array.isArray(data) && data[0]?.lat ? [{color:'#4ade80', locations:data}] : []);
}
function isBlocked(z, mapId) {
    const list = Store.blocked[mapId];
    if(!list || !Array.isArray(list)) return false;
    const zMinX = z.min.lon, zMaxX = z.max.lon, zMinY = z.min.lat, zMaxY = z.max.lat;
    return list.some(b => {
        if(typeof b === 'string') {
            const m = b.match(/lat([\d\.]+)-([\d\.]+)_lon([\d\.]+)-([\d\.]+)/);
            if(m) {
                const bMinLat=parseFloat(m[1]), bMaxLat=parseFloat(m[2]), bMinLon=parseFloat(m[3]), bMaxLon=parseFloat(m[4]);
                return !(zMaxX < bMinLon || zMinX > bMaxLon || zMaxY < bMinLat || zMinY > bMaxLat);
            }
        }
        return false;
    });
}

const Store = {
    cfg: {}, map: null, dom: { mapImg: null },
    data: { dinos:{}, res:{}, pois:[], obs:[], caves:[], players:[], regions:[], mapInfo: null },
    icons: {}, trans: {d:{}, r:{}}, sharing: {}, blocked: {}, alphas: {},
    selDino: null, selectedPOI: null, activeRes: new Set(), activeObs: new Set(), activeRegions: new Set(),
    layers: { public: false, caves: false, players: false },
    view: { x:0, y:0, scale:1 }, sidebarOpen: true, mapKey: null,
    currentImgIdx: 0, liveMode: false
};

window.MapEngine = {
    el: null, cvs: null, ctx: null, img: null, marker: null, iconCache: new Map(), pattern: null, cavePattern: null,
    isDown: false, startX: 0, startY: 0, moved: false, resizeObserver: null,
    init() {
        this.el = document.getElementById('world');
        this.img = document.getElementById('map-image-layer');
        this.cvs = document.getElementById('data-canvas');
        this.marker = document.getElementById('selection-marker');
        this.ctx = this.cvs.getContext('2d');
        Store.dom.mapImg = this.img;
        
        const p = document.createElement('canvas'); p.width=10; p.height=10;
        const pc = p.getContext('2d');
        pc.strokeStyle='rgba(255,255,255,0.3)'; pc.lineWidth=1;
        pc.beginPath(); pc.moveTo(0,10); pc.lineTo(10,0); pc.stroke();
        this.cavePattern = this.ctx.createPattern(p, 'repeat'); // FIX: Correct variable name
        
        const input = document.getElementById('input-layer');
        input.onmousedown = e => { 
            // MERGED CLICK HANDLER: DRAG START + CLOSE DROPDOWN
            this.isDown=true; this.moved=false; this.startX=e.clientX; this.startY=e.clientY; input.style.cursor='grabbing';
            document.getElementById('dino-dropdown-content').classList.remove('open'); 
            document.querySelector('.select-trigger').classList.remove('active');
        };
        window.onmouseup = () => { this.isDown=false; input.style.cursor='grab'; };
        input.onmousemove = e => {
            if(this.isDown) {
                const dx=e.clientX-this.startX, dy=e.clientY-this.startY;
                if(Math.abs(dx)>2 || Math.abs(dy)>2) {
                    this.moved=true; Store.view.x+=dx; Store.view.y+=dy;
                    this.startX=e.clientX; this.startY=e.clientY; this.update();
                }
            }
            const r = this.el.getBoundingClientRect();
            const lat = ((e.clientY-r.top)/r.height)*100, lon = ((e.clientX-r.left)/r.width)*100;
            document.getElementById('lat').innerText = Math.max(0,Math.min(100,lat)).toFixed(1);
            document.getElementById('lon').innerText = Math.max(0,Math.min(100,lon)).toFixed(1);
        };
        input.onwheel = e => { e.preventDefault(); const r = this.el.getBoundingClientRect(); const mx = e.clientX - r.left, my = e.clientY - r.top; const factor = e.deltaY > 0 ? 0.9 : 1.1; this.zoomAt(factor, mx, my); };
        input.onclick = e => {
            if(this.moved) return;
            const r = this.el.getBoundingClientRect();
            const cx = e.clientX - r.left, cy = e.clientY - r.top;
            this.click((cx/r.width)*100, (cy/r.height)*100);
        };
        new ResizeObserver(() => this.fit()).observe(document.getElementById('viewport'));
        setTimeout(()=>this.fit(), 100);
    },
    fit() {
        if(!this.el) return;
        const vp = document.getElementById('viewport');
        const s = Math.min(vp.clientWidth, vp.clientHeight);
        const size = Math.max(100, s);
        this.el.style.width=size+'px'; this.el.style.height=size+'px';
        this.cvs.width=size; this.cvs.height=size;
        this.el.style.left=(vp.clientWidth-size)/2+'px';
        this.el.style.top=(vp.clientHeight-size)/2+'px';
        this.draw();
    },
    load(url) {
        const safe = fixUrl(url); this.img.src = safe;
        document.getElementById('loader').classList.remove('hidden');
        this.img.onload = () => { document.getElementById('loader').classList.add('hidden'); this.fit(); this.draw(); };
        this.img.onerror = () => { document.getElementById('error-log').innerText = "Bild Fehler: " + safe; document.getElementById('loader').classList.add('hidden'); this.draw(); };
        this.setMarker(null);
    },
    update() { if(this.el) this.el.style.transform = `translate(${Store.view.x}px, ${Store.view.y}px) scale(${Store.view.scale})`; },
    zoomAt(f, mx, my) {
        const os = Store.view.scale; const ns = Math.max(0.5, Math.min(10, os * f));
        if(os===ns) return;
        Store.view.x += mx - (mx * (ns/os)); Store.view.y += my - (my * (ns/os)); Store.view.scale = ns;
        this.update();
    },
    reset() { Store.view.scale=1; Store.view.x=0; Store.view.y=0; this.update(); this.fit(); },
    setMarker(d) {
        const m = this.marker;
        if(!d) { m.style.display='none'; return; }
        m.style.left=d.lon+'%'; m.style.top=d.lat+'%'; m.style.display='block';
    },
    getImg(url) {
        if(!url) return null;
        const safeUrl = fixUrl(url);
        if(this.iconCache.has(safeUrl)) return this.iconCache.get(safeUrl);
        const i = new Image(); i.src = safeUrl; i.onload = () => this.draw();
        this.iconCache.set(safeUrl, i); return i;
    },
    getIcon(key) {
        if(!key) return null;
        let url = key.includes('http') ? key : Store.icons[key]?.iconUrl;
        return this.getImg(url);
    },
    getResIcon(key) { return this.getIcon(key); },
    draw() {
        if(!this.ctx) return;
        const w=this.cvs.width, h=this.cvs.height, ctx=this.ctx;
        ctx.clearRect(0,0,w,h);
        
        // DRAW REGIONS (Bottom Layer)
        Store.activeRegions.forEach(id => {
            const reg = Store.data.regions.find(r => r.id == id);
            if(reg && reg.imageUrl) {
                const img = this.getImg(reg.imageUrl);
                if(img && img.complete) {
                    ctx.save();
                    ctx.shadowColor = reg.color || '#fff'; ctx.shadowBlur = 20;
                    ctx.drawImage(img, 0, 0, w, h);
                    ctx.restore();
                }
            }
        });

        if(Store.selDino && Store.data.dinos[Store.selDino]) {
            Store.data.dinos[Store.selDino].forEach(z => {
                if(isBlocked(z, Store.mapKey)) return;
                const x=(z.min.lon/100)*w, y=(z.min.lat/100)*h, zw=((z.max.lon-z.min.lon)/100)*w, zh=((z.max.lat-z.min.lat)/100)*h;
                let col = '#22c55e'; const sc = (parseFloat(z.chance)||0.5)*(parseFloat(z.weight)||1);
                for(let r of CFG.rarity) if(sc>=r.th) { col=r.c; break; }
                
                // CAVE PATTERN FIX
                if(z.isCave) { 
                    ctx.fillStyle = this.cavePattern; 
                    ctx.fillRect(x, y, zw, zh); 
                } else {
                    ctx.fillStyle = hexToRgba(col, 0.4); 
                    ctx.fillRect(x, y, zw, zh);
                }
                
                ctx.strokeStyle=col; ctx.lineWidth=2; ctx.strokeRect(x,y,zw,zh);
            });
        }
        Store.activeRes.forEach(k => {
            if(Store.data.res[k]) {
                const img = this.getIcon(k); const col = {'Metal':'#b87333'}[k]||'#fff';
                Store.data.res[k].forEach(p => {
                    const cx=(p.lon/100)*w, cy=(p.lat/100)*h; const sz = Math.min(32, 12+((p.size||1)*2));
                    if(img && img.complete) ctx.drawImage(img, cx-sz/2, cy-sz/2, sz, sz); else { ctx.fillStyle=col; ctx.beginPath(); ctx.arc(cx,cy,sz/3,0,7); ctx.fill(); }
                });
            }
        });
        if(Store.layers.public) this.drawList(Store.data.pois, w, h, '#ff2a00');
        if(Store.layers.caves) this.drawList(Store.data.caves, w, h, '#a855f7');
        
        Store.activeObs.forEach(k => {
            const o = Store.data.obs.find(i=>i.name===k);
            if(o) {
                let img = this.getIcon(o.icon) || this.getIcon(o.name);
                const cx=(o.lon/100)*w, cy=(o.lat/100)*h;
                if(img && img.complete) { const ht=60, ar=img.naturalWidth/img.naturalHeight; ctx.drawImage(img, cx-(ht*ar)/2, cy-ht, ht*ar, ht); }
                else { ctx.fillStyle='#f00'; ctx.beginPath(); ctx.arc(cx,cy,8,0,7); ctx.fill(); }
            }
        });
        if(Store.layers.players && Store.data.players.length) {
            const pal = ['#4ade80', '#60a5fa', '#facc15', '#f87171', '#c084fc', '#fb923c'];
            Store.data.players.forEach((g, i) => {
                ctx.fillStyle = g.color || pal[i%pal.length]; ctx.strokeStyle = '#fff'; ctx.lineWidth=1.5;
                const pts = g.locations || g.spawnPoints || (Array.isArray(g)?g:[]);
                pts.forEach(p => { if(p.lat!==undefined) { const cx=(p.lon/100)*w, cy=(p.lat/100)*h; ctx.beginPath(); ctx.arc(cx,cy,8,0,7); ctx.fill(); ctx.stroke(); } });
            });
        }
    },

    drawList(list, w, h, c) {
        const ctx = this.ctx;
        list.forEach(p => {
            const cx=(p.lon/100)*w, cy=(p.lat/100)*h;
            const img = this.getIcon(p.icon) || this.getIcon(p.name);
            if(img && img.complete) ctx.drawImage(img, cx-16, cy-16, 32, 32); else { this.ctx.fillStyle=c; this.ctx.beginPath(); this.ctx.arc(cx,cy,6,0,7); this.ctx.fill(); this.ctx.stroke(); }
        });
    },
    click(lon, lat) {
        const rad = 2.5; let hit = null, type = '';
        if(Store.layers.public) { hit = Store.data.pois.find(p => Math.hypot(p.lon-lon, p.lat-lat)<rad); if(hit) type='public'; }
        if(!hit && Store.layers.caves) { hit = Store.data.caves.find(p => Math.hypot(p.lon-lon, p.lat-lat)<rad); if(hit) type='caves'; }
        if(hit) Ui.showInfo(hit, type);
        
        // CHECK CLICKS FOR RES/OBS/PLAYERS IF NO POI HIT
        if(!hit) {
             const r = 2.0; 
             Store.activeRes.forEach(k => {
                 if(Store.data.res[k]) {
                     const p = Store.data.res[k].find(pt => Math.hypot(pt.lon-lon, pt.lat-lat) < r);
                     if(p) { Ui.showInfo({name: Store.trans.res[k]||k, lat: p.lat, lon: p.lon, description: "Ressource"}, 'res'); hit = true; }
                 }
             });
             if(!hit) {
                 Store.activeObs.forEach(k => {
                    const o = Store.data.obs.find(i=>i.name===k);
                    if(o && Math.hypot(o.lon-lon, o.lat-lat) < r) { Ui.showInfo(o, 'obs'); hit = true; }
                 });
             }
             if(!hit && Store.layers.players) {
                 Store.data.players.forEach(g => {
                     const p = (g.locations || g.spawnPoints || []).find(pt => pt.lat && Math.hypot(pt.lon-lon, pt.lat-lat) < r);
                     if(p) { Ui.showInfo({name: "Spieler Spawn", lat: p.lat, lon: p.lon, description: g.name || "Spawn Zone"}, 'player'); hit = true; }
                 });
             }
        }
    }
};

window.Ui = {
    init(cfg) {
        const s = document.getElementById('map-select');
        Object.keys(cfg).forEach(k => { if(cfg[k].activated) { const o=document.createElement('option'); o.value=k; o.textContent=cfg[k].displayName; s.appendChild(o); } });
        s.onchange = e => Data.loadMap(e.target.value);
    },
    toggleSidebar() { const sb = document.getElementById('sidebar'); const tg = document.getElementById('sidebar-toggle'); const c = sb.classList.toggle('collapsed'); tg.innerHTML = c ? '‚ñ∂' : '‚óÄ'; setTimeout(()=>MapEngine.fit(), 310); },
    toggleFullscreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else if(document.exitFullscreen) document.exitFullscreen(); },
    tab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const map = {dinos:0, res:1, pois:2};
        if(map[id]!==undefined) document.querySelectorAll('.tab-btn')[map[id]].classList.add('active');
        document.getElementById('view-'+id).classList.add('active');
        setTimeout(()=>MapEngine.fit(), 10);
    },
    
    // LIVE MODE TOGGLE (FIXED ID CLASS HANDLING)
    toggleLiveMode() {
        Store.liveMode = !Store.liveMode;
        const btn = document.getElementById('live-map-btn');
        const frame = document.getElementById('live-map-frame'); // Correct ID
        const body = document.body;

        if (Store.liveMode) {
            btn.classList.add('live-active');
            body.classList.add('live-mode-active');
            frame.classList.remove('hidden'); // SHOW FRAME
            frame.src = Store.map.liveMapDataUrl || Store.map.LiveMapDataUrl || Store.map.iframeUrl || ""; 
        } else {
            btn.classList.remove('live-active');
            body.classList.remove('live-mode-active');
            frame.classList.add('hidden'); // HIDE FRAME
            frame.src = "";
        }
    },

    renderDinos(term="") {
        const l = document.getElementById('dino-list-root'); if(!l) return;
        const t = term.toLowerCase();
        const keys = Object.keys(Store.data.dinos).sort();
        const show = keys.filter(k => (Store.trans.dinos[k]||k).toLowerCase().includes(t));
        l.innerHTML = show.map(k => {
            const n = Store.trans.dinos[k]||k; const i = Store.icons[k]?.iconUrl || 'https://placehold.co/24'; const sel = Store.selDino===k ? 'selected' : '';
            return `<div class="select-item ${sel}" onclick="Ui.selDino('${k}','${n}')"><img src="${fixUrl(i)}"><span>${n}</span></div>`;
        }).join('');
    },
    toggleDinoDropdown() { const d = document.getElementById('dino-dropdown-content'); d.classList.toggle('open'); document.querySelector('.select-trigger').classList.toggle('active'); if(d.classList.contains('open')) document.getElementById('search-dino').focus(); },
    selDino(k, n) { Store.selDino = k; document.getElementById('dino-trigger-text').textContent = n; document.getElementById('dino-clear-btn').classList.remove('hidden'); this.toggleDinoDropdown(); MapEngine.draw(); },
    clearDino() { Store.selDino = null; document.getElementById('dino-trigger-text').textContent = "W√§hle Dino..."; document.getElementById('dino-clear-btn').classList.add('hidden'); MapEngine.draw(); },
    resetDinoSelectionUI() { this.clearDino(); },
    renderRes() {
        const l = document.getElementById('list-res'); if(!l) return;
        l.innerHTML = Object.keys(Store.data.res).sort().map(k => {
            const i = Store.icons[k]?.iconUrl; const ih = i ? `<img src="${fixUrl(i)}" style="width:20px;height:20px;margin-right:8px;object-fit:contain">` : '';
            return `<div class="toggle-item" onclick="Ui.togRes('${k}',this)"><div class="chk"></div>${ih}<span class="text-xs text-gray-300">${Store.trans.res[k]||k}</span></div>`;
        }).join('');
    },
    togRes(k, el) { if(Store.activeRes.has(k)) { Store.activeRes.delete(k); el.classList.remove('checked'); } else { Store.activeRes.add(k); el.classList.add('checked'); } MapEngine.draw(); },
    renderObs() {
        const l = document.getElementById('list-obelisks'); if(!l) return;
        l.innerHTML = Store.data.obs.map(o => `<div class="toggle-item" onclick="Ui.togObs('${o.name}',this)"><div class="chk"></div><span class="text-xs text-gray-300">${o.name}</span></div>`).join('');
    },
    togObs(k, el) { if(Store.activeObs.has(k)) { Store.activeObs.delete(k); el.classList.remove('checked'); } else { Store.activeObs.add(k); el.classList.add('checked'); } MapEngine.draw(); },
    renderRegions() {
        const l = document.getElementById('list-regions'); const c = document.getElementById('region-container');
        if(!l || !c) return;
        // FIX: Handle both array and object {regions:[]}
        let regs = Store.data.regions;
        if(regs && regs.regions && Array.isArray(regs.regions)) regs = regs.regions;
        if(!Array.isArray(regs)) regs = [];

        Store.data.regions = regs; // Normalize
        
        console.log("Region Check: ", regs); // Debug

        if(regs.length === 0) { 
             c.classList.remove('hidden'); 
             l.innerHTML = '<div class="text-xs text-red-500 italic p-2">Keine Regionen geladen.</div>';
             return; 
        }
        c.classList.remove('hidden');
        l.innerHTML = regs.map(r => `<div class="toggle-item" onclick="Ui.togRegion('${r.id}', this)"><div class="chk"></div><span class="text-xs text-gray-300">${r.name}</span></div>`).join('');
    },
    togRegion(id, el) { if(Store.activeRegions.has(id)) { Store.activeRegions.delete(id); el.classList.remove('checked'); } else { Store.activeRegions.add(id); el.classList.add('checked'); } MapEngine.draw(); },

    showInfo(d, type) {
        Store.selectedPOI = d; MapEngine.setMarker(d);
        document.getElementById('info-title').textContent = d.name || "Info";
        
        let media = '';
        if(d.images?.length) {
            media = `<div class="relative group cursor-pointer" onclick="Ui.openDetail()">
                <img src="${fixUrl(d.images[0])}" class="w-full rounded mb-4 border border-gray-700">
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                    <span class="img-overlay-btn">üîç VERGR√ñSSERN</span>
                </div>
            </div>`;
        } else if(d.icon || Store.icons[d.name]?.iconUrl) media = `<img src="${fixUrl(d.icon || Store.icons[d.name]?.iconUrl)}" class="w-20 mx-auto mb-4">`;

        let extra = '';
        if(type === 'caves' && d.artifacts) {
            extra = `<div class="text-xs font-bold text-amber-500 mt-4 mb-2 tracking-wider">ARTEFAKTE</div>` +
            d.artifacts.map(a => {
                let url = a.icon || Store.icons[a.name]?.iconUrl; // FIX: Fallback to global
                if(url) url = fixUrl(url); 
                const img = url ? `<img src="${url}" class="artifact-icon">` : '';
                return `<div class="artifact-row">${img}<span>${a.name}</span></div>`;
            }).join('');
        }
        
        if (type === 'public' || type === 'caves') {
            const listTitle = type === 'public' ? 'ANDERE SPOTS' : 'ANDERE H√ñHLEN';
            const sourceList = type === 'public' ? Store.data.pois : Store.data.caves;
            const listItems = sourceList.map(item => {
                const isActive = item === d ? 'active' : '';
                const idx = sourceList.indexOf(item);
                return `<div class="related-item ${isActive}" onclick="Ui.selectFromList('${type}', ${idx})">${item.name}</div>`;
            }).join('');
            extra += `<div class="text-xs font-bold text-gray-500 mt-6 mb-2 tracking-wider">${listTitle}</div><div class="flex flex-col gap-1 related-list">${listItems}</div>`;
        }
        document.getElementById('info-body').innerHTML = `${media}<div class="flex justify-center gap-4 mb-4 text-xs font-mono text-gray-500 bg-black p-2 rounded border border-[#333]"><span>LAT: <span class="text-orange-500 font-bold">${d.lat.toFixed(1)}</span></span><span>LON: <span class="text-orange-500 font-bold">${d.lon.toFixed(1)}</span></span></div><div class="text-sm text-gray-400 whitespace-pre-wrap">${d.description || d.shortDescription || 'Keine Beschreibung.'}</div>${extra}`;
        document.getElementById('info-panel').classList.add('visible');
    },

    openDetail() {
        const d = Store.selectedPOI; if(!d) return;
        Store.currentImgIdx = 0;
        this.updateDetailModal(d);
        document.getElementById('detail-modal').classList.add('visible');
    },
    updateDetailModal(d) {
        document.getElementById('detail-title').textContent = d.name || "Detail";
        const images = d.images || (d.icon ? [d.icon] : []);
        const currentSrc = images.length ? images[Store.currentImgIdx] : "";
        document.getElementById('detail-img').src = fixUrl(currentSrc);
        document.getElementById('detail-lat').textContent = d.lat.toFixed(1);
        document.getElementById('detail-lon').textContent = d.lon.toFixed(1);
        document.getElementById('detail-desc').textContent = d.longDescription || d.description || "Keine weitere Beschreibung.";

        document.getElementById('gal-prev').style.display = images.length > 1 ? 'flex' : 'none';
        document.getElementById('gal-next').style.display = images.length > 1 ? 'flex' : 'none';
        document.getElementById('gal-count').style.display = images.length > 1 ? 'block' : 'none';
        if(images.length > 1) document.getElementById('gal-count').textContent = `${Store.currentImgIdx + 1} / ${images.length}`;

        let arts = '';
        if(d.artifacts) {
             arts = `<div class="mt-6 border-t border-gray-700 pt-4"><h3 class="text-amber-500 font-bold mb-2">ARTEFAKTE</h3><div class="grid grid-cols-2 gap-2">` +
             d.artifacts.map(a => `<div class="modal-artifact-row">${a.name}</div>`).join('') + `</div></div>`;
        }
        document.getElementById('detail-artifacts').innerHTML = arts;
    },
    nextImg() {
        const d = Store.selectedPOI; if(!d || !d.images || d.images.length < 2) return;
        Store.currentImgIdx = (Store.currentImgIdx + 1) % d.images.length;
        this.updateDetailModal(d);
    },
    prevImg() {
        const d = Store.selectedPOI; if(!d || !d.images || d.images.length < 2) return;
        Store.currentImgIdx = (Store.currentImgIdx - 1 + d.images.length) % d.images.length;
        this.updateDetailModal(d);
    },
    closeDetail() { document.getElementById('detail-modal').classList.remove('visible'); },
    
    selectFromList(type, index) {
        const sourceList = type === 'public' ? Store.data.pois : Store.data.caves;
        const item = sourceList[index];
        if(item) this.showInfo(item, type);
    },
    closeInfo() { document.getElementById('info-panel').classList.remove('visible'); MapEngine.setMarker(null); },
    setSpawnStatus(type, msg) { const txt = document.getElementById('spawn-msg'); if(txt) txt.textContent = msg; }
};

window.Layers = {
    toggle(k) { Store.layers[k]=!Store.layers[k]; document.getElementById('tog-'+k).classList.toggle('checked'); MapEngine.draw(); },
    toggleAllPois() {
        const on = !Store.layers.public; Store.layers.public = on; Store.layers.caves = on;
        ['tog-public','tog-caves','tog-all-pois'].forEach(id => { const el = document.getElementById(id); if(el) { if(on) el.classList.add('checked'); else el.classList.remove('checked'); } });
        MapEngine.draw();
    }
};

window.Res = {
    clear() { Store.activeRes.clear(); document.querySelectorAll('#list-res .toggle-item').forEach(e => e.classList.remove('checked')); document.getElementById('tog-all-res').classList.remove('checked'); MapEngine.draw(); },
    toggleAll() {
        const allKeys = Object.keys(Store.data.res);
        if(!allKeys.length) return;
        const on = Store.activeRes.size !== allKeys.length;
        if(on) { allKeys.forEach(k => Store.activeRes.add(k)); document.querySelectorAll('#list-res .toggle-item').forEach(e => e.classList.add('checked')); document.getElementById('tog-all-res').classList.add('checked'); } 
        else { this.clear(); }
        MapEngine.draw();
    }
};

window.Obs = {
    toggleAll() {
        const allKeys = Store.data.obs.map(o => o.name);
        if(!allKeys.length) return;
        const on = Store.activeObs.size !== allKeys.length;
        
        if (on) {
            allKeys.forEach(k => Store.activeObs.add(k));
            document.querySelectorAll('#list-obelisks .toggle-item').forEach(e => e.classList.add('checked'));
            document.getElementById('tog-all-obs').classList.add('checked');
        } else {
            Store.activeObs.clear();
            document.querySelectorAll('#list-obelisks .toggle-item').forEach(e => e.classList.remove('checked'));
            document.getElementById('tog-all-obs').classList.remove('checked');
        }
        MapEngine.draw();
    }
};

window.Reg = {
    toggleAll() {
        const allKeys = Store.data.regions.map(r => r.id);
        if(!allKeys.length) return;
        const on = Store.activeRegions.size !== allKeys.length;

        if(on) {
             allKeys.forEach(k => Store.activeRegions.add(k));
             document.querySelectorAll('#list-regions .toggle-item').forEach(e => e.classList.add('checked'));
             document.getElementById('tog-all-regions').classList.add('checked');
        } else {
             Store.activeRegions.clear();
             document.querySelectorAll('#list-regions .toggle-item').forEach(e => e.classList.remove('checked'));
             document.getElementById('tog-all-regions').classList.remove('checked');
        }
        MapEngine.draw();
    }
};

const Data = {
    async init() {
        try {
            const [c, i, t, sh, bl, al] = await Promise.all([
                fetchJson(CFG.urlC), fetchJson(CFG.urlI), fetchJson(CFG.urlT),
                fetchJson(CFG.urlShare), fetchJson(CFG.urlBlock), fetchJson(CFG.urlAlpha)
            ]);
            if(!c) throw "Config Error";
            Store.cfg = c;
            Store.icons = {...(i?.Items||{}), ...(i?.Kreaturen||{}), ...(i?.Ressourcen||{})};
            if(t) { Store.trans.dinos = t.Kreaturen||{}; Store.trans.res = t.Ressourcen||{}; }
            Store.sharing = sh || {};
            Store.blocked = bl || {};
            Store.alphas = al || {};
            Ui.init(c); this.loadMap('TheIsland');
        } catch(e) { console.error(e); }
    },
    async loadMap(k) {
        try {
            const c = Store.cfg[k]; Store.map = c; Store.mapKey = k; 
            Store.selDino=null; Store.activeRes.clear(); Store.activeObs.clear(); Store.activeRegions.clear();
            Ui.resetDinoSelectionUI(); MapEngine.reset(); MapEngine.load(c.mapImageUrl);
            
            // CONFIG KEYS FIX: Check ALL variants for regions
            const regUrl = c.regionDataUrl || c.RegionDataUrl || c.regionsDataUrl || c.RegionsDataUrl;
            if(regUrl) console.log("Region URL: " + regUrl);
            const infoUrl = c.infoBadgeUrl || c.InfoBadgeUrl;
            
            // LIVE MAP URL Check
            const liveUrl = c.liveMapDataUrl || c.LiveMapDataUrl || c.iframeUrl;
            if(liveUrl) { Store.map.liveMapDataUrl = liveUrl; }

            // Fixed Array with Null fallbacks to ensure index stability
            const reqs = [
                c.creatureDataUrl, c.resourceDataUrl, c.publicSpotsDataUrl, 
                c.obeliskDataUrl, c.caveSpotsDataUrl, c.playerSpawnDataUrl,
                c.alphaDataUrl, regUrl, infoUrl
            ];
            
            const res = await Promise.all(reqs.map(u => u ? fetchJson(u) : null));
            const [d,r,p,o,ca,pl,al,regData, infoData] = res; // Destructuring fixed indices

            // Robust Region Parsing
            let regionsList = [];
            if(regData) {
                if(Array.isArray(regData)) regionsList = regData;
                else if(regData.regions && Array.isArray(regData.regions)) regionsList = regData.regions;
            }
            console.log("Regions Loaded: " + regionsList.length);
            
            Store.data = { dinos: d?.dinoSpawns||{}, res: r?.resources||{}, pois: p?.publicSpots||[], obs: o?.obelisks||[], caves: ca?.caveSpots||[], players: findSpawns(pl), regions: regionsList, mapInfo: infoData };
            
            // Toggle Info & Live Buttons
            const infoBtn = document.getElementById('map-info-btn');
            if(infoBtn) { if(infoData) infoBtn.classList.remove('hidden'); else infoBtn.classList.add('hidden'); }
            
            const liveBtn = document.getElementById('live-map-btn');
            if(liveBtn) { if(liveUrl) liveBtn.classList.remove('hidden'); else liveBtn.classList.add('hidden'); }

            // ALPHA FIX
            if(c.alphaVariantKey && Store.alphas[c.alphaVariantKey]) {
                const variants = Store.alphas[c.alphaVariantKey];
                Object.keys(variants).forEach(normalName => {
                    const alphaName = variants[normalName];
                    if(Store.data.dinos[normalName]) {
                        Store.data.dinos[alphaName] = Store.data.dinos[normalName];
                        if(!Store.trans.dinos[alphaName]) Store.trans.dinos[alphaName] = alphaName;
                    }
                });
            }
            
            // Spawn Sharing
            if(Store.sharing) {
                Object.keys(Store.sharing).forEach(sourceName => {
                    const targets = Store.sharing[sourceName];
                    if (Array.isArray(targets) && Store.data.dinos[sourceName]) {
                        targets.forEach(targetName => {
                            if (!Store.data.dinos[targetName]) {
                                Store.data.dinos[targetName] = Store.data.dinos[sourceName];
                                if (!Store.trans.dinos[targetName]) Store.trans.dinos[targetName] = targetName;
                            }
                        });
                    }
                });
            }

            // CLEAN STATUS TEXT: Only dot if data ok
            const spawnMsg = Store.data.players.length ? "" : "Keine Daten"; 
            const spawnType = Store.data.players.length ? "ok" : "err";
            Ui.setSpawnStatus(spawnType, spawnMsg);
            document.getElementById('tog-players').classList.toggle('disabled', !Store.data.players.length);

            Ui.renderDinos(); Ui.renderRes(); Ui.renderObs(); Ui.renderRegions(); 
            if(typeof Ui.resetToggles === 'function') Ui.resetToggles();
            MapEngine.draw();
        } catch(e) { console.error("LoadMap Error", e); }
    }
};

document.getElementById('search-dino').oninput = e => Ui.renderDinos(e.target.value);
document.addEventListener("DOMContentLoaded", () => { MapEngine.init(); Data.init(); });

</script>
</body>
</html>
